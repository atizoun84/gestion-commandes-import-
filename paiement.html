<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B-one | Suivi paiement</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#7d2ae8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B-one Paiement">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        /* Adaptation plein √©cran */
        html, body { height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; }
        
        /* Header & Navbar */
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; flex-shrink: 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }
        .navbar-toggler { border: none; padding: 0; }
        .navbar-toggler:focus { box-shadow: none; }

        /* Contenu principal adaptatif */
        main { flex: 1 0 auto; width: 100%; max-width: 100%; }

        /* Barre de Recherche */
        .search-container { margin-top: -25px; position: relative; z-index: 10; width: 100%; }
        .search-input { 
            border-radius: 30px; border: none; padding: 15px 25px 15px 50px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-size: 1rem; width: 100%;
        }
        .search-icon { position: absolute; left: 20px; top: 15px; color: #888; font-size: 1.2rem; }

        /* Filtres Cat√©gories */
        .category-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 15px 0; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-badge { 
            white-space: nowrap; padding: 8px 20px; border-radius: 20px; 
            background: white; color: #555; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid transparent;
        }
        .cat-badge.active { background: var(--canva-purple); color: white; }

        /* Grille Produits (Masqu√©e structurellement) */
        #productGrid { display: none; }

        /* Modal Raffin√©e & Formulaire */
        .modal-content { border-radius: 30px; border: none; overflow: hidden; }
        .modal-header-img { background: #f8f9fa; padding: 20px; text-align: center; }
        .modal-product-img-lg { max-height: 150px; object-fit: contain; }
        .form-label { font-weight: 600; color: #555; font-size: 0.85rem; }
        .form-control, .form-select { border-radius: 12px; border: 1px solid #eee; padding: 10px 15px; }
        .form-control:focus { border-color: var(--canva-purple); box-shadow: none; }
        .readonly-info { background-color: #f8f9fa; border-radius: 10px; padding: 8px 12px; margin-bottom: 10px; font-size: 0.9rem; border: 1px solid #eee; }

        .btn-validate-order { 
            background: var(--canva-gradient); color: white; border: none; 
            border-radius: 15px; padding: 12px; font-weight: 700; width: 100%;
            margin-top: 10px; box-shadow: 0 5px 15px rgba(125, 42, 232, 0.3);
        }

        /* Section Mes Commandes */
        .orders-section { background: white; border-radius: 25px; padding: 25px; margin-top: 40px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .clickable-order-row { cursor: pointer; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
        .clickable-order-row:hover { background-color: #f8f9fa; }

        /* Publication Styles */
        .publish-header { border-bottom: 3px double #7d2ae8; padding-bottom: 10px; margin-bottom: 20px; }
        .publish-item { border-left: 4px solid #00c4cc; padding-left: 15px; margin-bottom: 15px; }
        .signature-area { margin-top: 30px; font-style: italic; border-top: 1px solid #eee; padding-top: 10px; }

        .btn-settle { padding: 2px 10px; font-size: 0.7rem; border-radius: 20px; float: right; }
    </style>
</head>
<body>

<header class="app-header shadow-lg">
    <nav class="navbar navbar-expand-lg navbar-dark container">
        <div class="container-fluid px-0">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <div>
                    <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">B-one</h1>
                    <small class="opacity-75" style="font-size: 0.65rem;">Suivi paiement</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="produits.html">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="panier.html">Panier</a></li>
                    <li class="nav-item"><a class="nav-link active" href="paiement.html">Suivi Paiements</a></li>
                    <li class="nav-item"><a class="nav-link" href="comptabilite.html">Comptabilit√©</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container px-4">
    <div class="search-container">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="orderSearchInput" class="form-control search-input" placeholder="Rechercher une commande par nom ou produit..." onkeyup="Shop.renderOrders()">
    </div>

    <div id="productGrid"></div>

    <section class="orders-section" id="customerOrdersSection">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
            <h2 class="h5 fw-bold mb-0"><i class="bi bi-wallet2 text-primary me-2"></i>Tableau de Bord des Paiements</h2>
            <button class="btn btn-dark rounded-pill px-4 fw-bold shadow-sm" onclick="Shop.openPublishModal()">
                <i class="bi bi-send-fill me-2 text-info"></i>PUBLIER COMMANDE
            </button>
        </div>
        <div class="table-responsive">
            <table class="table align-middle">
                <thead class="table-light small">
                    <tr>
                        <th>Vague</th>
                        <th>Client & Produit</th>
                        <th class="text-end">Reste √† Payer</th>
                    </tr>
                </thead>
                <tbody id="customerOrdersTable" class="small"></tbody>
            </table>
        </div>
    </section>
</main>

<div id="adminNotifyBtn" class="position-fixed bottom-0 start-0 m-3 d-none" style="z-index: 2001;">
    <button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
            style="width: 60px; height: 60px; background: var(--canva-gradient); border: 2px solid white;"
            onclick="AdminNotif.openModal()">
        <i class="bi bi-bell-fill fs-4"></i>
        <span id="notifCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
    </button>
</div>

<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
        <div class="modal-content shadow-lg">
            <div class="modal-header-img">
                <button type="button" class="btn-close float-end" data-bs-dismiss="modal"></button>
                <img id="orderModalImg" src="" class="modal-product-img-lg mt-3">
                <div class="mt-2">
                    <h4 class="fw-bold text-dark mb-0" id="orderModalTitle"></h4>
                    <small id="displayClientName" class="text-muted"></small>
                </div>
            </div>
            <div class="modal-body p-4">
                <form id="directOrderForm">
                    <input type="hidden" id="editOrderId">
                    <div class="mb-3">
                        <label class="form-label text-primary">Vente (D√ª: <span id="valBase">0</span>)</label>
                        <button type="button" class="btn btn-outline-success btn-settle" onclick="Shop.settleItem('paidBase', 'valBase')">Solder</button>
                        <input type="number" id="paidBase" class="form-control" placeholder="Montant pay√© sur la vente" oninput="Shop.updateTotalDisplay()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-primary">Transit (D√ª: <span id="valTransit">0</span>)</label>
                        <button type="button" class="btn btn-outline-success btn-settle" onclick="Shop.settleItem('paidTransit', 'valTransit')">Solder</button>
                        <input type="number" id="paidTransit" class="form-control" placeholder="Montant pay√© sur transit" oninput="Shop.updateTotalDisplay()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-primary">Douane (D√ª: <span id="valDouane">0</span>)</label>
                        <button type="button" class="btn btn-outline-success btn-settle" onclick="Shop.settleItem('paidDouane', 'valDouane')">Solder</button>
                        <input type="number" id="paidDouane" class="form-control" placeholder="Montant pay√© sur douane" oninput="Shop.updateTotalDisplay()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-primary">Livraison (D√ª: <span id="valLivr">0</span>)</label>
                        <button type="button" class="btn btn-outline-success btn-settle" onclick="Shop.settleItem('paidLivr', 'valLivr')">Solder</button>
                        <input type="number" id="paidLivr" class="form-control" placeholder="Montant pay√© sur livraison" oninput="Shop.updateTotalDisplay()">
                    </div>
                    <div class="p-3 bg-light rounded-3 mb-3 border border-danger text-center">
                        <small class="text-muted d-block mb-1">RESTE √Ä PAYER TOTAL</small>
                        <span class="h4 fw-bold text-danger" id="orderTotalDisplay">0 F CFA</span>
                    </div>
                    <button type="button" class="btn-validate-order" onclick="Shop.submitDirectOrder()">
                        <i class="bi bi-save me-2"></i>Enregistrer le Paiement
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="publishModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg modal-fullscreen-sm-down">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-dark text-white p-4">
                <h5 class="modal-title fw-bold"><i class="bi bi-file-earmark-text me-2"></i>BULLETIN OFFICIEL DES COMMANDES</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 p-md-5 bg-white" id="publishContent">
                <div class="publish-header text-center">
                    <h2 class="h4 fw-bold text-uppercase" id="pubCompanyName">B-ONE GROUP</h2>
                    <p class="text-muted small mb-0">Rapport de Situation des Commandes en Cours</p>
                    <small class="text-muted" id="pubDate"></small>
                </div>
                
                <div id="publishOrdersList"></div>

                <div class="signature-area text-end">
                    <p class="mb-0 fw-bold">Le Pr√©sident Directeur G√©n√©ral,</p>
                    <p class="text-primary fw-bold" id="pubCEO">Atizoun Plateny AMOUSSOU</p>
                    <small class="text-muted">Sign√© num√©riquement</small>
                </div>
            </div>
            <div class="modal-footer bg-light p-3">
                <button class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Fermer</button>
                <button class="btn btn-success rounded-pill px-4 shadow" onclick="Shop.copyAndShareWhatsApp()">
                    <i class="bi bi-whatsapp me-2"></i>Copier et Partager
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notifModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-header border-0 text-white" style="background: var(--canva-gradient); border-radius: 25px 25px 0 0;">
                <h5 class="modal-title fw-bold"><i class="bi bi-activity me-2"></i>Derniers Mouvements</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex justify-content-between mb-3 gap-2">
                    <input type="text" id="notifFilter" class="form-control rounded-pill w-50" placeholder="Filtrer par utilisateur..." oninput="AdminNotif.render()">
                    <button class="btn btn-outline-danger btn-sm rounded-pill px-3" onclick="AdminNotif.clearHistory()">R√©initialiser</button>
                </div>
                <div id="notifList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, remove, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {  
        apiKey: "AIzaSyCaLdUMDuWSfg7118-ZFpL1fARkM_BQ2zw",  
        authDomain: "b-one-database.firebaseapp.com",  
        projectId: "b-one-database",  
        storageBucket: "b-one-database.firebasestorage.app",  
        messagingSenderId: "423962812169",  
        appId: "1:423962812169:web:34961a338fe06e693e7dd8",
        databaseURL: "https://b-one-database-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Initialisation globale pour que le HTML puisse appeler les fonctions
    const session = JSON.parse(localStorage.getItem('BONE_USER_SESSION'));
    if (!session || session.role !== 'admin') {
        alert("Acc√®s refus√©. Seul l'administrateur peut acc√©der √† cette page.");
        window.location.href = 'login.html';
    }

    const CONFIG_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const DB_KEY = 'BONE_PRODUCTS_LIST';
    const ORDERS_KEY = 'BONE_ORDERS_HISTORY';

    window.Shop = {
        userOrders: [],
        products: [],

        init() {
            window.orderModalObj = new bootstrap.Modal(document.getElementById('orderModal'));
            window.publishModalObj = new bootstrap.Modal(document.getElementById('publishModal'));
            this.loadBranding();
            this.listenToFirebase();
        },

        listenToFirebase() {
            // Synchro Commandes
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                this.userOrders = data ? Object.values(data) : [];
                localStorage.setItem(ORDERS_KEY, JSON.stringify(this.userOrders));
                this.renderOrders();
            });

            // Synchro Produits
            onValue(ref(db, 'products'), (snapshot) => {
                const data = snapshot.val();
                this.products = data ? Object.values(data) : [];
                localStorage.setItem(DB_KEY, JSON.stringify(this.products));
            });
        },

        loadBranding() {
            const config = JSON.parse(localStorage.getItem(CONFIG_KEY));
            if(config) {
                if(config.logo) document.getElementById('navLogo').src = config.logo;
                if(config.companyName) {
                    document.getElementById('navCompanyName').innerText = config.companyName;
                    document.getElementById('pubCompanyName').innerText = config.companyName;
                }
                if(config.ceoName) document.getElementById('pubCEO').innerText = config.ceoName;
            }
        },

        renderOrders() {
            const queryText = document.getElementById('orderSearchInput').value.toLowerCase();
            const table = document.getElementById('customerOrdersTable');
            
            const filtered = this.userOrders.filter(o => 
                (o.prodName && o.prodName.toLowerCase().includes(queryText)) || 
                (o.client && o.client.toLowerCase().includes(queryText))
            );
            
            if (filtered.length === 0) {
                table.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">Aucune commande enregistr√©e.</td></tr>`;
                return;
            }
            
            table.innerHTML = filtered.map((o) => {
                const qte = parseInt(o.quantity || o.qty) || 1;
                const totalDu = ((parseFloat(o.price) || 0) + (parseFloat(o.transit) || 0) + (parseFloat(o.douane) || 0) + (parseFloat(o.livraison) || 0)) * qte;
                let paid = 0;
                if(o.isPricePayed) paid += (parseFloat(o.price) || 0) * qte;
                if(o.isTransitPayed) paid += (parseFloat(o.transit) || 0) * qte;
                if(o.isDouanePayed) paid += (parseFloat(o.douane) || 0) * qte;
                if(o.isLivraisonPayed) paid += (parseFloat(o.livraison) || 0) * qte;
                const reste = totalDu - paid;
                return `
                <tr class="clickable-order-row" onclick="Shop.editOrder('${o.id}')">
                    <td><span class="badge bg-light text-dark border">V${o.wave || 1}</span></td>
                    <td>
                        <div class="fw-bold text-dark">${o.client || 'Client inconnu'}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${o.prodName || 'Produit'}</div>
                    </td>
                    <td class="text-end fw-bold ${reste > 0 ? 'text-danger' : 'text-success'}">
                        ${reste.toLocaleString()} F CFA
                    </td>
                </tr>`;
            }).reverse().join('');
        },

        editOrder(orderId) {
            window.selectedOrder = this.userOrders.find(o => o.id === orderId);
            if(!window.selectedOrder) return;
            const p = this.products.find(prod => prod.id === window.selectedOrder.prodId) || {};
            const qte = parseInt(window.selectedOrder.quantity || window.selectedOrder.qty) || 1;
            document.getElementById('editOrderId').value = orderId;
            document.getElementById('orderModalImg').src = p.img || '';
            document.getElementById('orderModalTitle').innerText = window.selectedOrder.prodName;
            document.getElementById('displayClientName').innerText = `Client: ${window.selectedOrder.client} (Qt√©: ${qte})`;
            document.getElementById('valBase').innerText = (parseFloat(window.selectedOrder.price) * qte).toLocaleString();
            document.getElementById('valTransit').innerText = (parseFloat(window.selectedOrder.transit) * qte).toLocaleString();
            document.getElementById('valDouane').innerText = (parseFloat(window.selectedOrder.douane) * qte).toLocaleString();
            document.getElementById('valLivr').innerText = (parseFloat(window.selectedOrder.livraison) * qte).toLocaleString();
            document.getElementById('paidBase').value = window.selectedOrder.isPricePayed ? (parseFloat(window.selectedOrder.price) * qte) : 0;
            document.getElementById('paidTransit').value = window.selectedOrder.isTransitPayed ? (parseFloat(window.selectedOrder.transit) * qte) : 0;
            document.getElementById('paidDouane').value = window.selectedOrder.isDouanePayed ? (parseFloat(window.selectedOrder.douane) * qte) : 0;
            document.getElementById('paidLivr').value = window.selectedOrder.isLivraisonPayed ? (parseFloat(window.selectedOrder.livraison) * qte) : 0;
            this.updateTotalDisplay();
            window.orderModalObj.show();
        },

        settleItem(inputId, valId) {
            const val = document.getElementById(valId).innerText.replace(/\s/g, '');
            document.getElementById(inputId).value = parseFloat(val);
            this.updateTotalDisplay();
        },

        updateTotalDisplay() {
            const qte = parseInt(window.selectedOrder.quantity || window.selectedOrder.qty) || 1;
            const totalDu = ((parseFloat(window.selectedOrder.price) || 0) + (parseFloat(window.selectedOrder.transit) || 0) + (parseFloat(window.selectedOrder.douane) || 0) + (parseFloat(window.selectedOrder.livraison) || 0)) * qte;
            const pBase = parseFloat(document.getElementById('paidBase').value) || 0;
            const pTransit = parseFloat(document.getElementById('paidTransit').value) || 0;
            const pDouane = parseFloat(document.getElementById('paidDouane').value) || 0;
            const pLivr = parseFloat(document.getElementById('paidLivr').value) || 0;
            const reste = totalDu - (pBase + pTransit + pDouane + pLivr);
            document.getElementById('orderTotalDisplay').innerText = `${reste.toLocaleString()} F CFA`;
        },

        submitDirectOrder() {
            const orderId = document.getElementById('editOrderId').value;
            const o = this.userOrders.find(ord => ord.id === orderId);
            const qte = parseInt(o.quantity || o.qty) || 1;
            
            // Logique de validation
            const isVenteOk = parseFloat(document.getElementById('paidBase').value) >= (parseFloat(o.price) * qte);
            const isTransitOk = parseFloat(document.getElementById('paidTransit').value) >= (parseFloat(o.transit) * qte);
            const isDouaneOk = parseFloat(document.getElementById('paidDouane').value) >= (parseFloat(o.douane) * qte);
            const isLivrOk = parseFloat(document.getElementById('paidLivr').value) >= (parseFloat(o.livraison) * qte);

            update(ref(db, `orders/${orderId}`), {
                isPricePayed: isVenteOk,
                isTransitPayed: isTransitOk,
                isDouanePayed: isDouaneOk,
                isLivraisonPayed: isLivrOk
            });

            // Notification de modification
            push(ref(db, 'notifications'), {
                userId: session.name,
                details: `Paiement mis √† jour pour ${o.client} (${o.prodName})`,
                timestamp: Date.now(),
                read: false
            });

            window.orderModalObj.hide();
            alert("Situation de paiement mise √† jour et synchronis√©e.");
        },

        openPublishModal() {
            document.getElementById('pubDate').innerText = `Date : ${new Date().toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}`;
            const container = document.getElementById('publishOrdersList');
            if(this.userOrders.length === 0) {
                container.innerHTML = `<p class="text-center py-4">Aucune donn√©e √† publier.</p>`;
            } else {
                container.innerHTML = this.userOrders.map(o => {
                    const qte = parseInt(o.quantity || o.qty) || 1;
                    const vTotal = (parseFloat(o.price) || 0) * qte;
                    const tTotal = (parseFloat(o.transit) || 0) * qte;
                    const dTotal = (parseFloat(o.douane) || 0) * qte;
                    const vPaid = o.isPricePayed ? vTotal : 0;
                    const tPaid = o.isTransitPayed ? tTotal : 0;
                    const dPaid = o.isDouanePayed ? dTotal : 0;
                    const totalDu = vTotal + tTotal + dTotal + ((parseFloat(o.livraison)||0)*qte);
                    const paid = vPaid + tPaid + dPaid + (o.isLivraisonPayed ? ((parseFloat(o.livraison)||0)*qte) : 0);
                    const reste = totalDu - paid;
                    return `
                    <div class="publish-item">
                        <h6 class="fw-bold mb-1">${o.client} - ${o.prodName} <span class="badge bg-light text-dark border small">V${o.wave||1}</span></h6>
                        <div class="small">
                            <span class="text-muted">Vente:</span> ${vPaid.toLocaleString()} / ${vTotal.toLocaleString()} F CFA ${o.isPricePayed ? '‚úÖ' : '‚ùå'}<br>
                            <span class="text-muted">Transit:</span> ${tPaid.toLocaleString()} / ${tTotal.toLocaleString()} F CFA ${o.isTransitPayed ? '‚úÖ' : '‚ùå'}<br>
                            <span class="text-muted">Douane:</span> ${dPaid.toLocaleString()} / ${dTotal.toLocaleString()} F CFA ${o.isDouanePayed ? '‚úÖ' : '‚ùå'}<br>
                            <span class="text-danger fw-bold">RESTE TOTAL : ${reste.toLocaleString()} F CFA</span>
                        </div>
                    </div>`;
                }).join('');
            }
            window.publishModalObj.show();
        },

        copyAndShareWhatsApp() {
            const company = document.getElementById('pubCompanyName').innerText;
            const dateStr = document.getElementById('pubDate').innerText;
            const ceo = document.getElementById('pubCEO').innerText;
            let text = `üì¢ *${company} - BULLETIN OFFICIEL*\nüìÖ _${dateStr}_\n\n*SITUATION DES PAIEMENTS :*\n-----------------------------------\n\n`;
            this.userOrders.forEach(o => {
                const qte = parseInt(o.quantity || o.qty) || 1;
                const vT = (parseFloat(o.price) || 0) * qte;
                const tT = (parseFloat(o.transit) || 0) * qte;
                const dT = (parseFloat(o.douane) || 0) * qte;
                const totalDu = vT + tT + dT + ((parseFloat(o.livraison)||0)*qte);
                const paid = (o.isPricePayed?vT:0) + (o.isTransitPayed?tT:0) + (o.isDouanePayed?dT:0) + (o.isLivraisonPayed?((parseFloat(o.livraison)||0)*qte):0);
                text += `üë§ *Client :* ${o.client}\nüì¶ *Produit :* ${o.prodName} (V${o.wave||1})\nüíµ *Vente :* ${o.isPricePayed?'‚úÖ OK':'‚ùå '+(vT-(o.isPricePayed?vT:0)).toLocaleString()}\n‚ùå *RESTE :* ${(totalDu-paid).toLocaleString()} F CFA\n-----------------------------------\n\n`;
            });
            text += `\n‚úçÔ∏è *Sign√© :*\n*${ceo}*\n_PDG_`;
            navigator.clipboard.writeText(text).then(() => {
                alert("Rapport copi√© ! Redirection WhatsApp...");
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            });
        }
    };

    // SYSTEME DE NOTIFICATION ADMIN
    window.AdminNotif = {
        items: [],
        init() {
            if(session.role === 'admin') {
                document.getElementById('adminNotifyBtn').classList.remove('d-none');
                this.listen();
            }
        },
        listen() {
            onValue(ref(db, 'notifications'), (snap) => {
                const data = snap.val();
                this.items = data ? Object.entries(data).map(([id,v])=>({id,...v})).reverse() : [];
                const unread = this.items.filter(n => !n.read).length;
                const badge = document.getElementById('notifCount');
                badge.innerText = unread;
                badge.classList.toggle('d-none', unread === 0);
                this.render();
            });
        },
        render() {
            const container = document.getElementById('notifList');
            const filter = document.getElementById('notifFilter').value.toLowerCase();
            container.innerHTML = this.items
                .filter(n => n.userId.toLowerCase().includes(filter))
                .map(n => `
                <div class="card mb-2 border-0 shadow-sm ${n.read ? 'opacity-75' : 'border-start border-primary border-4'}">
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge bg-light text-primary small">${n.userId}</span>
                            <p class="mb-0 small fw-bold">${n.details}</p>
                            <small class="text-muted" style="font-size:0.7rem">${new Date(n.timestamp).toLocaleString()}</small>
                        </div>
                        ${!n.read ? `<button class="btn btn-sm btn-link text-decoration-none" onclick="AdminNotif.markRead('${n.id}')">Marquer lu</button>` : ''}
                    </div>
                </div>`).join('') || '<p class="text-center text-muted small">Aucun mouvement.</p>';
        },
        markRead(id) { update(ref(db, `notifications/${id}`), { read: true }); },
        clearHistory() {
            if(prompt("Code Admin pour supprimer :") === "0000") {
                remove(ref(db, 'notifications'));
            }
        },
        openModal() { new bootstrap.Modal(document.getElementById('notifModal')).show(); }
    };

    window.onload = () => {
        Shop.init();
        AdminNotif.init();
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<button onclick="logout()" class="btn btn-danger position-fixed bottom-0 end-0 m-3 rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; z-index: 2000; border: 2px solid white;">
    <i class="bi bi-power fs-4"></i>
</button>

<script>
    function logout() {
        if (confirm("Atizoun, voulez-vous vraiment vous d√©connecter de B-one ?")) {
            localStorage.removeItem('BONE_USER_SESSION');
            window.location.href = 'login.html';
        }
    }
</script>

</body>
</html>
