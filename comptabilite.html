<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-one | Tableau de Bord Financier</title>
    
    <meta name="theme-color" content="#7d2ae8">
    <link rel="manifest" href="./manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }

        .stats-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none;
            transition: transform 0.3s;
        }
        
        .accounting-section { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .table thead { background-color: #f8f9fa; border-radius: 15px; }
        
        .benefit-positive { color: #2ecc71 !important; font-weight: bold; }
        .benefit-negative { color: #e74c3c !important; font-weight: bold; }
        
        .col-date { width: 90px; }
        .col-vente { width: 100px; }
        .col-acq { width: 110px; }
        .col-marge { width: 100px; }
        .col-action { width: 50px; }

        .input-acquisition {
            width: 100%; border: 1px solid #ddd; border-radius: 8px;
            padding: 4px 8px; text-align: right; font-weight: 600;
            font-size: 0.85rem;
        }
        .input-acquisition:read-only { background-color: #f8f9fa; border-color: transparent; }

        .success-toast { 
            animation: fadeInSuccess 0.5s ease-out; background: #2ecc71; color: white; 
            padding: 10px 20px; border-radius: 50px; position: fixed; top: 20px; right: 20px; z-index: 9999;
        }
        @keyframes fadeInSuccess { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #chartWrapper { display: none; }

        #printHeader, #printFooter, #summaryPrint { display: none; }
        @media print {
            @page { size: auto; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #printArea { display: block; width: 100%; }
            #printHeader { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; text-align: center; }
            #printFooter { display: block; margin-top: 40px; page-break-inside: avoid; }
            #summaryPrint { display: block; margin-bottom: 30px; border: 1px solid #000; padding: 15px; }
            .stats-card { border: 1px solid #eee; box-shadow: none; margin-bottom: 20px; }
            .table { width: 100%; border-collapse: collapse; page-break-inside: auto; font-size: 9pt; }
            th, td { border: 1px solid #ddd !important; padding: 4px !important; }
        }

        /* STYLE MODALE NOTIFICATION RAFFINÉE */
        .notif-card { border-radius: 15px; transition: 0.2s; border: none; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .notif-unread { border-left: 5px solid var(--canva-purple) !important; background: #f8f0ff; }
    </style>
</head>
<body>

<div id="successMessage"></div>

<header class="app-header shadow-lg no-print">
    <nav class="navbar navbar-expand-lg navbar-dark container">
        <div class="container-fluid px-0">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">B-one</h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="produits.html">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="panier.html">Panier</a></li>
                    <li class="nav-item"><a class="nav-link" href="paiement.html">Paiement</a></li>
                    <li class="nav-item"><a class="nav-link active" href="comptabilite.html">Comptabilité</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container mt-4 px-4" id="printArea">
    <div id="printHeader">
        <h2 class="fw-bold text-uppercase mb-1" id="printTitle">B-ONE GROUP</h2>
        <p class="mb-0 fw-bold">BILAN FINANCIER GLOBAL ET ÉTAT DES CAPITAUX</p>
        <small class="text-muted" id="printPeriod">Période : Historique complet</small>
        <hr>
    </div>

    <div class="accounting-section mb-4 no-print">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="small fw-bold">Taux d'Épargne Croissance (%)</label>
                <input type="number" id="growthRate" class="form-control" value="10">
            </div>
            <div class="col-md-4">
                <label class="small fw-bold">Période du Bilan</label>
                <select id="periodFilter" class="form-select">
                    <option value="all">Tout l'historique</option>
                    <option value="day">Aujourd'hui</option>
                    <option value="week">Cette Semaine</option>
                    <option value="month">Ce Mois-ci</option>
                    <option value="year">Cette Année</option>
                </select>
            </div>
            <div class="col-md-4 d-flex gap-2 pt-3">
                <button class="btn btn-dark w-100" id="printBtn"><i class="bi bi-file-earmark-pdf"></i> Imprimer Bilan</button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-card h-100 bg-white">
                <div class="mb-3">
                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Chiffre d'Affaires Global</small>
                    <h5 class="fw-bold mb-0" id="totalSales">0 F CFA</h5>
                </div>
                <div class="mb-3 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-primary" style="font-size: 0.65rem;">Capital à Épargner (Stock)</small>
                    <h5 class="fw-bold mb-0" id="totalCapitalStock">0 F CFA</h5>
                </div>
                <div class="mb-0 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-info" style="font-size: 0.65rem;">Épargne de Croissance (Prévue)</small>
                    <h5 class="fw-bold mb-0" id="totalGrowthSaving">0 F CFA</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-success">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Bénéfice Brut (Marge)</small>
                <h4 class="fw-bold mb-2 text-success" id="totalGrossProfit">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Bénéfices)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawProfit">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Bénéfice Restant</small>
                <h5 class="fw-bold text-dark" id="remainingProfit">0 F CFA</h5>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-primary">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Capital + Épargne Croissance</small>
                <h4 class="fw-bold mb-2 text-primary" id="theoreticalCapital">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Capital/Inv.)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawCapital">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Capital Réel</small>
                <h5 class="fw-bold text-dark" id="remainingCapital">0 F CFA</h5>
            </div>
        </div>
    </div>

    <div class="text-center mb-3 no-print">
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" id="toggleChartBtn">
            <i class="bi bi-graph-up me-2"></i>Afficher le graphique d'évolution
        </button>
    </div>

    <div class="row g-3 mb-4 no-print" id="chartWrapper">
        <div class="col-12">
            <div class="stats-card">
                <h6 class="fw-bold mb-3"><i class="bi bi-graph-up text-purple me-2"></i>Évolution des Marges et Croissance</h6>
                <canvas id="evolutionChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 no-print">
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-danger">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Bénéfice</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outProfitAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outProfitMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-danger" id="addProfitW">OK</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-warning">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Capital/Épargne</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outCapAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outCapMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-warning" id="addCapW">OK</button>
                </div>
            </div>
        </div>
    </div>

    <section class="accounting-section">
        <div class="table-responsive">
            <table class="table align-middle" id="mainAccountingTable">
                <thead>
                    <tr class="small text-uppercase bg-light">
                        <th class="col-date">Date</th>
                        <th>Client & Désignation</th>
                        <th class="text-center">Vente (TTC Payé)</th>
                        <th class="text-center">Acquisition (Cap.)</th>
                        <th class="text-center text-info">Croissance</th>
                        <th class="text-end text-success">Marge Réelle</th>
                        <th class="text-end col-action no-print"></th>
                    </tr>
                </thead>
                <tbody id="accountingTable" class="small"></tbody>
            </table>
        </div>
    </section>

    <section class="accounting-section mt-4">
        <h6 class="fw-bold small border-bottom pb-2 mb-3">Journal des Mouvements de Caisse</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr class="small text-muted text-uppercase">
                        <th>Type</th>
                        <th>Motif</th>
                        <th class="text-end">Montant</th>
                        <th class="text-end no-print">Action</th>
                    </tr>
                </thead>
                <tbody id="withdrawLogs" class="small"></tbody>
            </table>
        </div>
    </section>

    <div id="printFooter">
        <div class="row">
            <div class="col-8">
                <small class="text-muted">Rapport financier généré automatiquement par B-ONE System le : <span id="currentPrintDate"></span></small>
            </div>
            <div class="col-4 text-center">
                <p class="mb-1 fw-bold text-decoration-underline">Le Président Directeur Général</p>
                <div style="height: 60px;"></div>
                <p class="fw-bold mb-0" id="ceoPrint">Atizoun Plateny AMOUSSOU</p>
                <small class="text-muted">Cachet et Signature</small>
            </div>
        </div>
    </div>
</main>

<div id="adminNotifyBtn" class="position-fixed bottom-0 start-0 m-3 d-none" style="z-index: 2001;">
    <button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
            style="width: 60px; height: 60px; background: var(--canva-gradient); border: 2px solid white;"
            id="openNotifBtn">
        <i class="bi bi-bell-fill fs-4"></i>
        <span id="notifCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">0</span>
    </button>
</div>

<div class="modal fade" id="notifModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 25px;">
            <div class="modal-header border-0 text-white" style="background: var(--canva-gradient); border-radius: 25px 25px 0 0;">
                <h5 class="modal-title fw-bold"><i class="bi bi-activity me-2"></i>Flux d'activités Temps Réel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex justify-content-between mb-3">
                    <input type="text" id="notifFilter" class="form-control rounded-pill w-50" placeholder="Filtrer par utilisateur...">
                    <button class="btn btn-outline-danger btn-sm rounded-pill" id="clearNotifBtn">Réinitialiser (Code Admin)</button>
                </div>
                <div id="notifList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<button onclick="logout()" class="btn btn-danger position-fixed bottom-0 end-0 m-3 rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; z-index: 2000; border: 2px solid white;">
    <i class="bi bi-power fs-4"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, push, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCaLdUMDuWSfg7118-ZFpL1fARkM_BQ2zw",
        authDomain: "b-one-database.firebaseapp.com",
        projectId: "b-one-database",
        storageBucket: "b-one-database.firebasestorage.app",
        messagingSenderId: "423962812169",
        appId: "1:423962812169:web:34961a338fe06e693e7dd8",
        databaseURL: "https://b-one-database-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const STORAGE_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const ORDERS_KEY = 'BONE_ORDERS_HISTORY'; 
    const FLUX_KEY = 'BONE_FINANCE_FLUX'; 
    const DB_KEY = 'BONE_PRODUCTS_LIST'; 

    let financeFlux = JSON.parse(localStorage.getItem(FLUX_KEY)) || [];
    let myChart = null;

    // --- LOGIQUE FINANCIÈRE ---
    window.Finance = {
        init() {
            this.loadBranding();
            document.getElementById('currentPrintDate').innerText = new Date().toLocaleString('fr-FR');
            
            // Écoute Firebase pour synchroniser les données financières partout
            onValue(ref(db, 'financeFlux'), (snapshot) => {
                const data = snapshot.val();
                financeFlux = data ? Object.values(data) : [];
                localStorage.setItem(FLUX_KEY, JSON.stringify(financeFlux));
                this.renderAccounting();
            });

            // Écoute des commandes
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                const orders = data ? Object.values(data) : [];
                localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));
                this.renderAccounting();
            });

            this.renderAccounting();
        },

        loadBranding() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(config) {
                if(config.companyName) {
                    document.getElementById('navCompanyName').innerText = config.companyName;
                    document.getElementById('printTitle').innerText = config.companyName;
                }
                if(config.ceoName) document.getElementById('ceoPrint').innerText = config.ceoName;
                if(config.logo) document.getElementById('navLogo').src = config.logo;
            }
        },

        toggleChart() {
            const wrapper = document.getElementById('chartWrapper');
            const btn = document.getElementById('toggleChartBtn');
            if(wrapper.style.display === 'block') {
                wrapper.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-graph-up me-2"></i>Afficher le graphique d\'évolution';
            } else {
                wrapper.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Masquer le graphique';
                this.renderAccounting(); 
            }
        },

        addWithdraw(type) {
            const amtId = type === 'profit' ? 'outProfitAmt' : 'outCapAmt';
            const motifId = type === 'profit' ? 'outProfitMotif' : 'outCapMotif';
            const amount = parseFloat(document.getElementById(amtId).value);
            const motif = document.getElementById(motifId).value;

            if(!amount || !motif) return alert("Veuillez remplir le montant et le motif");

            const newId = Date.now();
            const entry = {
                id: newId,
                type: type,
                amount: amount,
                motif: motif,
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: Date.now()
            };

            set(ref(db, 'financeFlux/' + newId), entry);
            document.getElementById(amtId).value = '';
            document.getElementById(motifId).value = '';
            this.showToast("Mouvement enregistré");
        },

        deleteWithdraw(id) {
            if(confirm("Supprimer cette opération financière ?")) {
                remove(ref(db, 'financeFlux/' + id));
            }
        },

        showToast(msg) {
            const t = document.getElementById('successMessage');
            t.innerHTML = `<div class="success-toast shadow-lg">${msg}</div>`;
            setTimeout(() => t.innerHTML = '', 3000);
        },

        renderAccounting() {
            const userOrders = JSON.parse(localStorage.getItem(ORDERS_KEY)) || [];
            const catalog = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            const period = document.getElementById('periodFilter').value;
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100 || 0;
            const table = document.getElementById('accountingTable');
            
            let stats = { sales: 0, acq: 0, growth: 0, gross: 0, outProfit: 0, outCap: 0 };
            let chartData = {};
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();

            table.innerHTML = userOrders.filter(o => {
                if (period === 'all') return true;
                const oTime = o.timestamp || 0;
                if (period === 'day') return oTime >= startOfDay;
                return true; 
            }).map((order) => {
                const pCat = catalog.find(p => p.id === order.prodId);
                let unitAcq = order.acquisitionPrice || (pCat ? pCat.priceBuy : 0);
                const quantity = order.qty || 1;
                const acqTotal = unitAcq * quantity;
                const payed = ((order.isPricePayed ? (order.price||0) : 0) + (order.isTransitPayed ? (order.transit||0) : 0)) * quantity;
                const growth = acqTotal * growthRate;
                const profit = payed - acqTotal - growth;

                stats.sales += payed; stats.acq += acqTotal; stats.growth += growth; stats.gross += profit;
                const dStr = order.timestamp ? new Date(order.timestamp).toLocaleDateString('fr-FR') : '-';
                if(dStr !== '-') chartData[dStr] = (chartData[dStr] || 0) + profit;

                return `<tr><td class="text-muted small">${dStr}</td><td><b>${order.prodName}</b><br><small>${order.client}</small></td><td class="text-center fw-bold">${payed.toLocaleString()}</td><td class="text-center">${acqTotal.toLocaleString()}</td><td class="text-center text-info">${Math.round(growth).toLocaleString()}</td><td class="text-end ${profit>=0?'benefit-positive':'benefit-negative'}">${Math.round(profit).toLocaleString()}</td><td class="text-end no-print"><i class="bi bi-lock-fill"></i></td></tr>`;
            }).reverse().join('');

            document.getElementById('withdrawLogs').innerHTML = financeFlux.map(f => {
                if(f.type === 'profit') stats.outProfit += f.amount; else stats.outCap += f.amount;
                return `<tr><td><span class="badge ${f.type==='profit'?'bg-danger':'bg-warning text-dark'}">${f.type}</span></td><td>${f.motif}</td><td class="text-end">-${f.amount.toLocaleString()}</td><td class="text-end no-print"><button class="btn btn-sm" onclick="Finance.deleteWithdraw(${f.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            }).join('');

            document.getElementById('totalSales').innerText = `${Math.round(stats.sales).toLocaleString()} F`;
            document.getElementById('totalGrossProfit').innerText = `${Math.round(stats.gross).toLocaleString()} F`;
            document.getElementById('remainingProfit').innerText = `${Math.round(stats.gross - stats.outProfit).toLocaleString()} F`;
            document.getElementById('remainingCapital').innerText = `${Math.round(stats.acq + stats.growth - stats.outCap).toLocaleString()} F`;
            if(myChart || document.getElementById('chartWrapper').style.display === 'block') this.updateChart(chartData);
        },

        updateChart(data) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(data),
                    datasets: [{ label: 'Marge', data: Object.values(data), borderColor: '#7d2ae8', tension: 0.3, fill: true, backgroundColor: 'rgba(125, 42, 232, 0.05)' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        },
        printPDF() { window.print(); }
    };

    // --- LOGIQUE NOTIFICATIONS ADMIN ---
    window.AdminNotif = {
        list: [],
        init() {
            const session = JSON.parse(localStorage.getItem('BONE_USER_SESSION'));
            if (session && session.role === 'admin') {
                document.getElementById('adminNotifyBtn').classList.remove('d-none');
                this.listen();
            }
        },
        listen() {
            onValue(ref(db, 'notifications'), (snapshot) => {
                const data = snapshot.val();
                this.list = data ? Object.entries(data).map(([id, val]) => ({id, ...val})).reverse() : [];
                const unread = this.list.filter(n => !n.read).length;
                const badge = document.getElementById('notifCount');
                badge.innerText = unread;
                badge.classList.toggle('d-none', unread === 0);
                this.render();
            });
        },
        render() {
            const container = document.getElementById('notifList');
            const filter = document.getElementById('notifFilter').value.toLowerCase();
            container.innerHTML = this.list
                .filter(n => n.userId.toLowerCase().includes(filter))
                .map(n => `
                    <div class="card notif-card ${!n.read ? 'notif-unread' : 'bg-light'}">
                        <div class="card-body d-flex justify-content-between align-items-center p-3">
                            <div>
                                <h6 class="mb-1 fw-bold">${n.details}</h6>
                                <small class="text-muted">Utilisateur: <b>${n.userId}</b> | ${new Date(n.timestamp).toLocaleString()}</small>
                            </div>
                            ${!n.read ? `<button class="btn btn-sm btn-primary rounded-pill" onclick="AdminNotif.markRead('${n.id}')">Lu</button>` : '<i class="bi bi-check-all text-success"></i>'}
                        </div>
                    </div>
                `).join('');
        },
        markRead(id) { update(ref(db, 'notifications/' + id), { read: true }); },
        clearHistory() {
            if(prompt("Code Admin ?") === "0000") remove(ref(db, 'notifications'));
        },
        openModal() { new bootstrap.Modal(document.getElementById('notifModal')).show(); }
    };

    // Attacher les événements
    document.getElementById('growthRate').onchange = () => Finance.renderAccounting();
    document.getElementById('periodFilter').onchange = () => Finance.renderAccounting();
    document.getElementById('printBtn').onclick = () => Finance.printPDF();
    document.getElementById('toggleChartBtn').onclick = () => Finance.toggleChart();
    document.getElementById('addProfitW').onclick = () => Finance.addWithdraw('profit');
    document.getElementById('addCapW').onclick = () => Finance.addWithdraw('capital');
    document.getElementById('openNotifBtn').onclick = () => AdminNotif.openModal();
    document.getElementById('notifFilter').oninput = () => AdminNotif.render();
    document.getElementById('clearNotifBtn').onclick = () => AdminNotif.clearHistory();

    window.Finance = Finance;
    window.AdminNotif = AdminNotif;
    Finance.init();
    AdminNotif.init();

</script>

<script>
    function logout() {
        if (confirm("Atizoun, voulez-vous vraiment vous déconnecter de B-one ?")) {
            localStorage.removeItem('BONE_USER_SESSION');
            window.location.href = 'login.html';
        }
    }
</script>
</body>
</html>
