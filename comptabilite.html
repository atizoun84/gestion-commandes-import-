<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-one | Comptabilité & Bénéfices</title>
    
    <meta name="theme-color" content="#7d2ae8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="B-one">
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }

        .stats-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none;
            transition: transform 0.3s;
        }
        
        .accounting-section { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .table thead { background-color: #f8f9fa; border-radius: 15px; }
        
        .benefit-positive { color: #2ecc71 !important; font-weight: bold; }
        .benefit-negative { color: #e74c3c !important; font-weight: bold; }
        
        /* Réduction de la largeur des colonnes */
        .col-date { width: 90px; }
        .col-vente { width: 100px; }
        .col-acq { width: 110px; }
        .col-marge { width: 100px; }
        .col-action { width: 50px; }

        .input-acquisition {
            width: 100%; border: 1px solid #ddd; border-radius: 8px;
            padding: 4px 8px; text-align: right; font-weight: 600;
            font-size: 0.85rem;
        }
        .input-acquisition:read-only { background-color: #f8f9fa; border-color: transparent; }

        .success-toast { 
            animation: fadeInSuccess 0.5s ease-out; background: #2ecc71; color: white; 
            padding: 10px 20px; border-radius: 50px; position: fixed; top: 20px; right: 20px; z-index: 9999;
        }
        @keyframes fadeInSuccess { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Styles Impression Optimisés */
        #printHeader, #printFooter { display: none; }
        @media print {
            @page { size: auto; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #printArea { display: block; width: 100%; }
            #printHeader { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; text-align: center; }
            #printFooter { display: block; margin-top: 40px; page-break-inside: avoid; }
            .stats-card { border: 1px solid #eee; box-shadow: none; margin-bottom: 20px; }
            .table { width: 100%; border-collapse: collapse; page-break-inside: auto; font-size: 9pt; }
            .table tr { page-break-inside: avoid; page-break-after: auto; }
            .table thead { display: table-header-group; }
            th, td { border: 1px solid #ddd !important; padding: 4px !important; }
            .input-acquisition { border: none !important; width: auto; font-size: 9pt; }
        }
    </style>
</head>
<body>

<div id="successMessage"></div>

<header class="app-header shadow-lg no-print">
    <nav class="navbar navbar-expand-lg navbar-dark container">
        <div class="container-fluid px-0">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">B-one</h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="produits.html">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="panier.html">Panier</a></li>
                    <li class="nav-item"><a class="nav-link" href="paiement.html">Paiement</a></li>
                    <li class="nav-item"><a class="nav-link active" href="comptabilite.html">Comptabilité</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container mt-4 px-4" id="printArea">
    <div id="printHeader">
        <h2 class="fw-bold text-uppercase mb-1" id="printTitle">B-ONE GROUP</h2>
        <p class="mb-0 fw-bold">RAPPORT DE COMPTABILITÉ ET ÉTAT DES MARGES</p>
        <small class="text-muted" id="printPeriod">Période : Toutes les données</small>
        <hr>
    </div>

    <div class="accounting-section mb-4 no-print">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="small fw-bold">Du</label>
                <input type="date" id="dateStart" class="form-control" onchange="Finance.renderAccounting()">
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Au</label>
                <input type="date" id="dateEnd" class="form-control" onchange="Finance.renderAccounting()">
            </div>
            <div class="col-md-3">
                <label class="small fw-bold">Recherche</label>
                <input type="text" id="financeSearch" class="form-control" placeholder="Client/Produit..." onkeyup="Finance.renderAccounting()">
            </div>
            <div class="col-md-3 d-flex gap-2">
                <button class="btn btn-dark w-100" onclick="Finance.printPDF()"><i class="bi bi-printer"></i> Imprimer Rapport</button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-card h-100">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Chiffre d'Affaires (Base)</small>
                <h4 class="fw-bold mb-3" id="totalSales">0 F CFA</h4>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Bénéfice Net PDG</small>
                <h4 class="fw-bold mb-0 text-success" id="totalProfit">0 F CFA</h4>
            </div>
        </div>
        <div class="col-md-8 no-print">
            <div class="stats-card h-100">
                <canvas id="evolutionChart" height="100"></canvas>
            </div>
        </div>
    </div>

    <section class="accounting-section">
        <div class="table-responsive">
            <table class="table align-middle" id="mainAccountingTable">
                <thead>
                    <tr class="small text-uppercase bg-light">
                        <th class="col-date">Date</th>
                        <th>Client & Désignation</th>
                        <th class="text-center col-vente">Vente (Base)</th>
                        <th class="text-center col-acq">Acquisition</th>
                        <th class="text-end col-marge">Marge PDG</th>
                        <th class="text-end col-action no-print"></th>
                    </tr>
                </thead>
                <tbody id="accountingTable" class="small"></tbody>
            </table>
        </div>
    </section>

    <div id="printFooter">
        <div class="row">
            <div class="col-8">
                <small class="text-muted">Généré le : <span id="currentPrintDate"></span></small>
            </div>
            <div class="col-4 text-center">
                <p class="mb-1 fw-bold text-decoration-underline">Le Président Directeur Général</p>
                <div style="height: 60px;"></div>
                <p class="fw-bold mb-0">Atizoun Plateny AMOUSSOU</p>
                <small class="text-muted">Cachet et Signature</small>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const STORAGE_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const ORDERS_KEY = 'BONE_USER_ORDERS';
    let userOrders = JSON.parse(localStorage.getItem(ORDERS_KEY)) || [];
    let myChart = null;

    const Finance = {
        init() {
            this.loadBranding();
            document.getElementById('currentPrintDate').innerText = new Date().toLocaleString('fr-FR');
            // Verrouillage intelligent basé sur l'existence d'un prix d'acquisition
            userOrders = userOrders.map(o => ({...o, isLocked: (parseFloat(o.acquisitionPrice) > 0)}));
            this.renderAccounting();
        },

        loadBranding() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(config && config.companyName) {
                document.getElementById('navCompanyName').innerText = config.companyName;
                document.getElementById('printTitle').innerText = config.companyName;
            }
        },

        toggleLock(index, isLock) {
            const input = document.getElementById(`acq-${index}`);
            if (isLock) {
                userOrders[index].acquisitionPrice = parseFloat(input.value) || 0;
                userOrders[index].isLocked = true;
                this.showToast("Saisie verrouillée");
            } else {
                userOrders[index].isLocked = false;
            }
            localStorage.setItem(ORDERS_KEY, JSON.stringify(userOrders));
            this.renderAccounting();
        },

        showToast(msg) {
            const t = document.getElementById('successMessage');
            t.innerHTML = `<div class="success-toast shadow-lg">${msg}</div>`;
            setTimeout(() => t.innerHTML = '', 3000);
        },

        renderAccounting() {
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;
            const query = document.getElementById('financeSearch').value.toLowerCase();
            const table = document.getElementById('accountingTable');
            
            let sumBase = 0, sumProfit = 0;
            let chartData = {};

            const filtered = userOrders.filter(o => {
                const oDate = o.date ? new Date(o.date.split('/').reverse().join('-')) : null;
                const matchesDate = (!start || oDate >= new Date(start)) && (!end || oDate <= new Date(end));
                const matchesSearch = (o.productName?.toLowerCase().includes(query) || o.customerName?.toLowerCase().includes(query));
                return matchesDate && matchesSearch;
            });

            if (filtered.length === 0) {
                table.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Aucune donnée disponible.</td></tr>`;
            } else {
                table.innerHTML = filtered.map(order => {
                    const idx = userOrders.indexOf(order);
                    const sale = parseFloat(order.priceBase) || 0;
                    const acq = parseFloat(order.acquisitionPrice) || 0;
                    const profit = sale - acq;
                    const locked = order.isLocked ?? true;

                    sumBase += sale;
                    sumProfit += profit;
                    if(order.date) chartData[order.date] = (chartData[order.date] || 0) + profit;

                    return `
                    <tr>
                        <td class="text-muted" style="font-size: 0.75rem;">${order.date || '-'}</td>
                        <td><div class="fw-bold" style="font-size: 0.85rem;">${order.productName}</div><div class="small text-muted" style="font-size: 0.7rem;">${order.customerName}</div></td>
                        <td class="text-center fw-bold">${sale.toLocaleString()}</td>
                        <td class="text-center">
                            <input type="number" id="acq-${idx}" class="input-acquisition" value="${acq}" ${locked ? 'readonly' : ''}>
                        </td>
                        <td class="text-end ${profit >= 0 ? 'benefit-positive' : 'benefit-negative'}">${profit.toLocaleString()}</td>
                        <td class="text-end no-print">
                            <button class="btn btn-sm p-1 ${locked ? 'text-primary' : 'btn-success'}" onclick="Finance.toggleLock(${idx}, ${!locked})">
                                <i class="bi ${locked ? 'bi-pencil-square' : 'bi-check-lg'}"></i>
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            }

            document.getElementById('totalSales').innerText = `${sumBase.toLocaleString()} F CFA`;
            document.getElementById('totalProfit').innerText = `${sumProfit.toLocaleString()} F CFA`;
            document.getElementById('printPeriod').innerText = (start && end) ? `Période : Du ${start} au ${end}` : "Période : Historique complet";
            
            this.updateChart(chartData);
        },

        updateChart(data) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if(myChart) myChart.destroy();
            const labels = Object.keys(data).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const values = labels.map(label => data[label]);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ label: 'Bénéfice PDG', data: values, borderColor: '#7d2ae8', tension: 0.3, fill: true, backgroundColor: 'rgba(125, 42, 232, 0.05)', pointRadius: 2 }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { ticks: { font: { size: 9 } } }, y: { ticks: { font: { size: 9 } } } }
                }
            });
        },

        printPDF() {
            window.print();
        }
    };

    window.onload = () => Finance.init();
</script>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('Service Worker enregistré !', reg))
                .catch(err => console.log('Erreur d\'enregistrement SW :', err));
        });
    }
</script>
</body>
</html>
