<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-one | Tableau de Bord Financier</title>
    
    <meta name="theme-color" content="#7d2ae8">
    <link rel="manifest" href="./manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }

        .stats-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none;
            transition: transform 0.3s;
        }
        
        .accounting-section { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .table thead { background-color: #f8f9fa; border-radius: 15px; }
        
        .benefit-positive { color: #2ecc71 !important; font-weight: bold; }
        .benefit-negative { color: #e74c3c !important; font-weight: bold; }
        
        .col-date { width: 90px; }
        .col-vente { width: 100px; }
        .col-acq { width: 110px; }
        .col-marge { width: 100px; }
        .col-action { width: 50px; }

        .input-acquisition {
            width: 100%; border: 1px solid #ddd; border-radius: 8px;
            padding: 4px 8px; text-align: right; font-weight: 600;
            font-size: 0.85rem;
        }
        .input-acquisition:read-only { background-color: #f8f9fa; border-color: transparent; }

        .success-toast { 
            animation: fadeInSuccess 0.5s ease-out; background: #2ecc71; color: white; 
            padding: 10px 20px; border-radius: 50px; position: fixed; top: 20px; right: 20px; z-index: 9999;
        }
        @keyframes fadeInSuccess { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Style pour masquer le graphique */
        #chartWrapper { display: none; }

        /* Styles Impression Optimisés */
        #printHeader, #printFooter, #summaryPrint { display: none; }
        @media print {
            @page { size: auto; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #printArea { display: block; width: 100%; }
            #printHeader { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; text-align: center; }
            #printFooter { display: block; margin-top: 40px; page-break-inside: avoid; }
            #summaryPrint { display: block; margin-bottom: 30px; border: 1px solid #000; padding: 15px; }
            .stats-card { border: 1px solid #eee; box-shadow: none; margin-bottom: 20px; }
            .table { width: 100%; border-collapse: collapse; page-break-inside: auto; font-size: 9pt; }
            th, td { border: 1px solid #ddd !important; padding: 4px !important; }
        }
    </style>
</head>
<body>

<div id="successMessage"></div>

<header class="app-header shadow-lg no-print">
    <nav class="navbar navbar-expand-lg navbar-dark container">
        <div class="container-fluid px-0">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">B-one</h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="produits.html">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="panier.html">Panier</a></li>
                    <li class="nav-item"><a class="nav-link" href="paiement.html">Paiement</a></li>
                    <li class="nav-item"><a class="nav-link active" href="comptabilite.html">Comptabilité</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container mt-4 px-4" id="printArea">
    <div id="printHeader">
        <h2 class="fw-bold text-uppercase mb-1" id="printTitle">B-ONE GROUP</h2>
        <p class="mb-0 fw-bold">BILAN FINANCIER GLOBAL ET ÉTAT DES CAPITAUX</p>
        <small class="text-muted" id="printPeriod">Période : Historique complet</small>
        <hr>
    </div>

    <div class="accounting-section mb-4 no-print">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="small fw-bold">Taux d'Épargne Croissance (%)</label>
                <input type="number" id="growthRate" class="form-control" value="10" onchange="Finance.renderAccounting()">
            </div>
            <div class="col-md-4">
                <label class="small fw-bold">Période du Bilan</label>
                <select id="periodFilter" class="form-select" onchange="Finance.renderAccounting()">
                    <option value="all">Tout l'historique</option>
                    <option value="day">Aujourd'hui</option>
                    <option value="week">Cette Semaine</option>
                    <option value="month">Ce Mois-ci</option>
                    <option value="year">Cette Année</option>
                </select>
            </div>
            <div class="col-md-4 d-flex gap-2 pt-3">
                <button class="btn btn-dark w-100" onclick="Finance.printPDF()"><i class="bi bi-file-earmark-pdf"></i> Imprimer Bilan</button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-card h-100 bg-white">
                <div class="mb-3">
                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Chiffre d'Affaires Global</small>
                    <h5 class="fw-bold mb-0" id="totalSales">0 F CFA</h5>
                </div>
                <div class="mb-3 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-primary" style="font-size: 0.65rem;">Capital à Épargner (Stock)</small>
                    <h5 class="fw-bold mb-0" id="totalCapitalStock">0 F CFA</h5>
                </div>
                <div class="mb-0 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-info" style="font-size: 0.65rem;">Épargne de Croissance (Prévue)</small>
                    <h5 class="fw-bold mb-0" id="totalGrowthSaving">0 F CFA</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-success">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Bénéfice Brut (Marge)</small>
                <h4 class="fw-bold mb-2 text-success" id="totalGrossProfit">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Bénéfices)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawProfit">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Bénéfice Restant</small>
                <h5 class="fw-bold text-dark" id="remainingProfit">0 F CFA</h5>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-primary">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Capital + Épargne Croissance</small>
                <h4 class="fw-bold mb-2 text-primary" id="theoreticalCapital">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Capital/Inv.)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawCapital">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Capital Réel</small>
                <h5 class="fw-bold text-dark" id="remainingCapital">0 F CFA</h5>
            </div>
        </div>
    </div>

    <div class="text-center mb-3 no-print">
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" id="toggleChartBtn" onclick="Finance.toggleChart()">
            <i class="bi bi-graph-up me-2"></i>Afficher le graphique d'évolution
        </button>
    </div>

    <div class="row g-3 mb-4 no-print" id="chartWrapper">
        <div class="col-12">
            <div class="stats-card">
                <h6 class="fw-bold mb-3"><i class="bi bi-graph-up text-purple me-2"></i>Évolution des Marges et Croissance</h6>
                <canvas id="evolutionChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 no-print">
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-danger">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Bénéfice</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outProfitAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outProfitMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-danger" onclick="Finance.addWithdraw('profit')">OK</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-warning">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Capital/Épargne</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outCapAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outCapMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-warning" onclick="Finance.addWithdraw('capital')">OK</button>
                </div>
            </div>
        </div>
    </div>

    <section class="accounting-section">
        <div class="table-responsive">
            <table class="table align-middle" id="mainAccountingTable">
                <thead>
                    <tr class="small text-uppercase bg-light">
                        <th class="col-date">Date</th>
                        <th>Client & Désignation</th>
                        <th class="text-center">Vente (TTC Payé)</th>
                        <th class="text-center">Acquisition (Cap.)</th>
                        <th class="text-center text-info">Croissance</th>
                        <th class="text-end text-success">Marge Réelle</th>
                        <th class="text-end col-action no-print"></th>
                    </tr>
                </thead>
                <tbody id="accountingTable" class="small"></tbody>
            </table>
        </div>
    </section>

    <section class="accounting-section mt-4">
        <h6 class="fw-bold small border-bottom pb-2 mb-3">Journal des Mouvements de Caisse</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr class="small text-muted text-uppercase">
                        <th>Type</th>
                        <th>Motif</th>
                        <th class="text-end">Montant</th>
                        <th class="text-end no-print">Action</th>
                    </tr>
                </thead>
                <tbody id="withdrawLogs" class="small"></tbody>
            </table>
        </div>
    </section>

    <div id="printFooter">
        <div class="row">
            <div class="col-8">
                <small class="text-muted">Rapport financier généré automatiquement par B-ONE System le : <span id="currentPrintDate"></span></small>
            </div>
            <div class="col-4 text-center">
                <p class="mb-1 fw-bold text-decoration-underline">Le Président Directeur Général</p>
                <div style="height: 60px;"></div>
                <p class="fw-bold mb-0" id="ceoPrint">Atizoun Plateny AMOUSSOU</p>
                <small class="text-muted">Cachet et Signature</small>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Logique d'enregistrement PWA
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('B-ONE SW enregistré !'))
                .catch(err => console.error('Erreur SW:', err));
        });
    }

    const STORAGE_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const ORDERS_KEY = 'BONE_ORDERS_HISTORY'; 
    const FLUX_KEY = 'BONE_FINANCE_FLUX'; 
    const DB_KEY = 'BONE_PRODUCTS_LIST'; // Clé correcte pour récupérer les prix d'achat

    let userOrders = [];
    let financeFlux = JSON.parse(localStorage.getItem(FLUX_KEY)) || [];
    let myChart = null;

    const Finance = {
        init() {
            this.loadBranding();
            document.getElementById('currentPrintDate').innerText = new Date().toLocaleString('fr-FR');
            this.renderAccounting();
        },

        loadBranding() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(config) {
                if(config.companyName) {
                    document.getElementById('navCompanyName').innerText = config.companyName;
                    document.getElementById('printTitle').innerText = config.companyName;
                }
                if(config.ceoName) {
                    document.getElementById('ceoPrint').innerText = config.ceoName;
                }
                if(config.logo) {
                    document.getElementById('navLogo').src = config.logo;
                }
            }
        },

        toggleChart() {
            const wrapper = document.getElementById('chartWrapper');
            const btn = document.getElementById('toggleChartBtn');
            if(wrapper.style.display === 'block') {
                wrapper.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-graph-up me-2"></i>Afficher le graphique d\'évolution';
            } else {
                wrapper.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Masquer le graphique';
                this.renderAccounting(); 
            }
        },

        addWithdraw(type) {
            const amtId = type === 'profit' ? 'outProfitAmt' : 'outCapAmt';
            const motifId = type === 'profit' ? 'outProfitMotif' : 'outCapMotif';
            const amount = parseFloat(document.getElementById(amtId).value);
            const motif = document.getElementById(motifId).value;

            if(!amount || !motif) return alert("Veuillez remplir le montant et le motif");

            financeFlux.push({
                id: Date.now(),
                type: type,
                amount: amount,
                motif: motif,
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: Date.now()
            });

            localStorage.setItem(FLUX_KEY, JSON.stringify(financeFlux));
            document.getElementById(amtId).value = '';
            document.getElementById(motifId).value = '';
            this.showToast("Mouvement enregistré");
            this.renderAccounting();
        },

        deleteWithdraw(id) {
            if(!confirm("Supprimer ce mouvement ?")) return;
            financeFlux = financeFlux.filter(f => f.id !== id);
            localStorage.setItem(FLUX_KEY, JSON.stringify(financeFlux));
            this.renderAccounting();
        },

        showToast(msg) {
            const t = document.getElementById('successMessage');
            t.innerHTML = `<div class="success-toast shadow-lg">${msg}</div>`;
            setTimeout(() => t.innerHTML = '', 3000);
        },

        renderAccounting() {
            userOrders = JSON.parse(localStorage.getItem(ORDERS_KEY)) || [];
            // Utilisation de la clé BONE_PRODUCTS_LIST pour retrouver le prix d'achat brut
            const catalog = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            
            const period = document.getElementById('periodFilter').value;
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100 || 0;
            const table = document.getElementById('accountingTable');
            
            let stats = {
                sales: 0, acq: 0, growth: 0, gross: 0,
                outProfit: 0, outCap: 0
            };
            let chartData = {};

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            
            const dayOfWeek = now.getDay() || 7; 
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (dayOfWeek - 1)).getTime();
            
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();

            const filteredOrders = userOrders.filter(o => {
                if (period === 'all') return true;
                const oTime = o.timestamp ? new Date(o.timestamp).getTime() : 0;
                if (period === 'day') return oTime >= startOfDay;
                if (period === 'week') return oTime >= startOfWeek;
                if (period === 'month') return oTime >= startOfMonth;
                if (period === 'year') return oTime >= startOfYear;
                return true;
            });

            table.innerHTML = filteredOrders.map((order) => {
                // On cherche le produit dans le catalogue par son nom pour récupérer le prix d'achat brut
                const productInCatalog = catalog.find(p => p.name === order.prodName);
                
                let unitAcquisition = 0;
                // Priorité 1: Prix d'acquisition enregistré directement dans la commande
                // Priorité 2: Prix d'achat brut (priceBuy) défini dans le catalogue de produits
                if (order.acquisitionPrice && parseFloat(order.acquisitionPrice) > 0) {
                    unitAcquisition = parseFloat(order.acquisitionPrice);
                } else if (productInCatalog && productInCatalog.priceBuy) {
                    unitAcquisition = parseFloat(productInCatalog.priceBuy);
                } else if (order.rawPrice) {
                    unitAcquisition = parseFloat(order.rawPrice);
                }

                const quantity = parseInt(order.qty) || 1;
                const acq = unitAcquisition * quantity;

                const vBase = parseFloat(order.price) || 0;
                const tPrice = parseFloat(order.transit) || 0;
                const dPrice = parseFloat(order.douane) || 0;
                const lPrice = parseFloat(order.livraison) || 0;
                
                let payedAmount = 0;
                if(order.isPricePayed) payedAmount += vBase;
                if(order.isTransitPayed) payedAmount += tPrice;
                if(order.isDouanePayed) payedAmount += dPrice;
                if(order.isLivraisonPayed) payedAmount += lPrice;

                const growth = acq * growthRate;
                const profit = payedAmount - acq - growth;

                stats.sales += payedAmount; 
                stats.acq += acq; 
                stats.growth += growth; 
                stats.gross += profit;

                const dateStr = order.timestamp ? new Date(order.timestamp).toLocaleDateString('fr-FR') : '-';
                if(dateStr !== '-') chartData[dateStr] = (chartData[dateStr] || 0) + profit;

                return `
                <tr>
                    <td class="text-muted" style="font-size: 0.7rem;">${dateStr}</td>
                    <td><div class="fw-bold">${order.prodName}</div><div class="text-muted small">${order.client} (Qté: ${quantity})</div></td>
                    <td class="text-center fw-bold">${payedAmount.toLocaleString()}</td>
                    <td class="text-center">
                        <input type="number" class="input-acquisition" value="${acq}" readonly title="Prix d'achat unitaire: ${unitAcquisition}">
                    </td>
                    <td class="text-center text-info fw-bold">${Math.round(growth).toLocaleString()}</td>
                    <td class="text-end ${profit >= 0 ? 'benefit-positive' : 'benefit-negative'}">${Math.round(profit).toLocaleString()}</td>
                    <td class="text-end no-print"><i class="bi bi-lock-fill text-muted"></i></td>
                </tr>`;
            }).reverse().join('');

            const filteredFlux = financeFlux.filter(f => {
                if (period === 'all') return true;
                const fTime = f.timestamp || 0;
                if (period === 'day') return fTime >= startOfDay;
                if (period === 'week') return fTime >= startOfWeek;
                if (period === 'month') return fTime >= startOfMonth;
                if (period === 'year') return fTime >= startOfYear;
                return true;
            });

            const logTable = document.getElementById('withdrawLogs');
            logTable.innerHTML = filteredFlux.map(f => {
                if(f.type === 'profit') stats.outProfit += f.amount;
                else stats.outCap += f.amount;
                return `
                <tr>
                    <td><span class="badge ${f.type==='profit'?'bg-danger':'bg-warning text-dark'}">${f.type.toUpperCase()}</span></td>
                    <td>${f.motif} <br><small class="text-muted">${f.date}</small></td>
                    <td class="text-end fw-bold">-${f.amount.toLocaleString()}</td>
                    <td class="text-end no-print">
                        <button class="btn btn-sm text-muted" onclick="Finance.deleteWithdraw(${f.id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('totalSales').innerText = `${stats.sales.toLocaleString()} F`;
            document.getElementById('totalCapitalStock').innerText = `${stats.acq.toLocaleString()} F`;
            document.getElementById('totalGrowthSaving').innerText = `${Math.round(stats.growth).toLocaleString()} F`;
            
            document.getElementById('totalGrossProfit').innerText = `${Math.round(stats.gross).toLocaleString()} F`;
            document.getElementById('totalWithdrawProfit').innerText = `-${stats.outProfit.toLocaleString()} F`;
            document.getElementById('remainingProfit').innerText = `${Math.round(stats.gross - stats.outProfit).toLocaleString()} F`;

            const totalCapPossible = stats.acq + stats.growth;
            document.getElementById('theoreticalCapital').innerText = `${Math.round(totalCapPossible).toLocaleString()} F`;
            document.getElementById('totalWithdrawCapital').innerText = `-${stats.outCap.toLocaleString()} F`;
            document.getElementById('remainingCapital').innerText = `${Math.round(totalCapPossible - stats.outCap).toLocaleString()} F`;

            if(document.getElementById('chartWrapper').style.display === 'block') {
                this.updateChart(chartData);
            }
        },

        updateChart(data) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if(myChart) myChart.destroy();
            const labels = Object.keys(data).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const values = labels.map(label => data[label]);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'Performance Marge Réelle', 
                        data: values, 
                        borderColor: '#7d2ae8', 
                        tension: 0.3, 
                        fill: true, 
                        backgroundColor: 'rgba(125, 42, 232, 0.05)', 
                        pointRadius: 3 
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        },

        printPDF() {
            window.print();
        }
    };

    window.onload = () => Finance.init();
</script>
</body>
</html>
