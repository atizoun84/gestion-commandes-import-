<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B-one | Tableau de Bord Financier</title>
    
    <meta name="theme-color" content="#7d2ae8">
    <link rel="manifest" href="./manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }

        .stats-card {
            background: white; border-radius: 20px; padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none;
            transition: transform 0.3s;
        }
        
        .accounting-section { background: white; border-radius: 25px; padding: 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); }
        .table thead { background-color: #f8f9fa; border-radius: 15px; }
        
        .benefit-positive { color: #2ecc71 !important; font-weight: bold; }
        .benefit-negative { color: #e74c3c !important; font-weight: bold; }
        
        .col-date { width: 90px; }
        .col-vente { width: 100px; }
        .col-acq { width: 110px; }
        .col-marge { width: 100px; }
        .col-action { width: 50px; }

        .input-acquisition {
            width: 100%; border: 1px solid #ddd; border-radius: 8px;
            padding: 4px 8px; text-align: right; font-weight: 600;
            font-size: 0.85rem;
        }
        .input-acquisition:read-only { background-color: #f8f9fa; border-color: transparent; }

        .success-toast { 
            animation: fadeInSuccess 0.5s ease-out; background: #2ecc71; color: white; 
            padding: 10px 20px; border-radius: 50px; position: fixed; top: 20px; right: 20px; z-index: 9999;
        }
        @keyframes fadeInSuccess { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #chartWrapper { display: none; }

        #printHeader, #printFooter, #summaryPrint { display: none; }
        @media print {
            @page { size: auto; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; }
            .no-print { display: none !important; }
            #printArea { display: block; width: 100%; }
            #printHeader { display: block; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; text-align: center; }
            #printFooter { display: block; margin-top: 40px; page-break-inside: avoid; }
            #summaryPrint { display: block; margin-bottom: 30px; border: 1px solid #000; padding: 15px; }
            .stats-card { border: 1px solid #eee; box-shadow: none; margin-bottom: 20px; }
            .table { width: 100%; border-collapse: collapse; page-break-inside: auto; font-size: 9pt; }
            th, td { border: 1px solid #ddd !important; padding: 4px !important; }
        }

        .text-purple { color: var(--canva-purple); }
    </style>
</head>
<body>

<div id="successMessage"></div>

<header class="app-header shadow-lg no-print">
    <nav class="navbar navbar-expand-lg navbar-dark container">
        <div class="container-fluid px-0">
            <a class="navbar-brand d-flex align-items-center gap-2" href="#">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">B-one</h1>
            </a>
            
            <div class="ms-auto d-flex align-items-center">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>

            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Accueil</a></li>
                    <li class="nav-item"><a class="nav-link" href="produits.html">Produits</a></li>
                    <li class="nav-item"><a class="nav-link" href="panier.html">Panier</a></li>
                    <li class="nav-item"><a class="nav-link" href="paiement.html">Paiement</a></li>
                    <li class="nav-item"><a class="nav-link active" href="comptabilite.html">Comptabilité</a></li>
                    <li class="nav-item"><a class="nav-link" href="configuration.html">Configuration</a></li>
                    <li class="nav-item"><a class="nav-link" href="maintenance.html">Maintenance</a></li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container mt-4 px-4" id="printArea">
    <div id="printHeader">
        <h2 class="fw-bold text-uppercase mb-1" id="printTitle">B-ONE GROUP</h2>
        <p class="mb-0 fw-bold">BILAN FINANCIER GLOBAL ET ÉTAT DES CAPITAUX</p>
        <small class="text-muted" id="printPeriod">Période : Historique complet</small>
        <hr>
    </div>

    <div class="accounting-section mb-4 no-print">
        <div class="row g-3 align-items-center">
            <div class="col-md-4">
                <label class="small fw-bold">Taux d'Épargne Croissance (%)</label>
                <input type="number" id="growthRate" class="form-control" value="10" onchange="Finance.renderAccounting()">
            </div>
            <div class="col-md-4">
                <label class="small fw-bold">Période du Bilan</label>
                <select id="periodFilter" class="form-select" onchange="Finance.renderAccounting()">
                    <option value="all">Tout l'historique</option>
                    <option value="day">Aujourd'hui</option>
                    <option value="week">Cette Semaine</option>
                    <option value="month">Ce Mois-ci</option>
                    <option value="year">Cette Année</option>
                </select>
            </div>
            <div class="col-md-4 d-flex gap-2 pt-3">
                <button class="btn btn-dark w-100" onclick="Finance.printPDF()"><i class="bi bi-file-earmark-pdf"></i> Imprimer Bilan</button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="stats-card h-100 bg-white">
                <div class="mb-3">
                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Chiffre d'Affaires Global</small>
                    <h5 class="fw-bold mb-0" id="totalSales">0 F CFA</h5>
                </div>
                <div class="mb-3 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-primary" style="font-size: 0.65rem;">Capital à Épargner (Stock)</small>
                    <h5 class="fw-bold mb-0" id="totalCapitalStock">0 F CFA</h5>
                </div>
                <div class="mb-0 border-top pt-2">
                    <small class="text-muted d-block text-uppercase fw-bold text-info" style="font-size: 0.65rem;">Épargne de Croissance (Prévue)</small>
                    <h5 class="fw-bold mb-0" id="totalGrowthSaving">0 F CFA</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-success">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Bénéfice Brut (Marge)</small>
                <h4 class="fw-bold mb-2 text-success" id="totalGrossProfit">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Bénéfices)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawProfit">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Bénéfice Restant</small>
                <h5 class="fw-bold text-dark" id="remainingProfit">0 F CFA</h5>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stats-card h-100 border-start border-4 border-primary">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Capital + Épargne Croissance</small>
                <h4 class="fw-bold mb-2 text-primary" id="theoreticalCapital">0 F CFA</h4>
                <hr class="my-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Total Retraits (Capital/Inv.)</small>
                <p class="mb-1 fw-bold text-danger" id="totalWithdrawCapital">0 F CFA</p>
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.65rem;">Solde Capital Réel</small>
                <h5 class="fw-bold text-dark" id="remainingCapital">0 F CFA</h5>
            </div>
        </div>
    </div>

    <div class="text-center mb-3 no-print">
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-4" id="toggleChartBtn" onclick="Finance.toggleChart()">
            <i class="bi bi-graph-up me-2"></i>Afficher le graphique d'évolution
        </button>
    </div>

    <div class="row g-3 mb-4 no-print" id="chartWrapper">
        <div class="col-12">
            <div class="stats-card">
                <h6 class="fw-bold mb-3"><i class="bi bi-graph-up text-purple me-2"></i>Évolution des Marges et Croissance</h6>
                <canvas id="evolutionChart" height="120"></canvas>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-4 no-print">
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-danger">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Bénéfice</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outProfitAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outProfitMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-danger" onclick="Finance.addWithdraw('profit')">OK</button>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="stats-card border-top border-3 border-warning">
                <h6 class="fw-bold small mb-3">Saisir un Retrait sur Capital/Épargne</h6>
                <div class="input-group input-group-sm mb-2">
                    <input type="number" id="outCapAmt" class="form-control" placeholder="Montant">
                    <input type="text" id="outCapMotif" class="form-control" placeholder="Motif">
                    <button class="btn btn-warning" onclick="Finance.addWithdraw('capital')">OK</button>
                </div>
            </div>
        </div>
    </div>

    <section class="accounting-section">
        <div class="table-responsive">
            <table class="table align-middle" id="mainAccountingTable">
                <thead>
                    <tr class="small text-uppercase bg-light">
                        <th class="col-date">Date</th>
                        <th>Client & Désignation</th>
                        <th class="text-center">Vente (TTC Payé)</th>
                        <th class="text-center">Acquisition (Cap.)</th>
                        <th class="text-center text-info">Croissance</th>
                        <th class="text-end text-success">Marge Réelle</th>
                        <th class="text-end col-action no-print"></th>
                    </tr>
                </thead>
                <tbody id="accountingTable" class="small"></tbody>
            </table>
        </div>
    </section>

    <section class="accounting-section mt-4">
        <h6 class="fw-bold small border-bottom pb-2 mb-3">Journal des Mouvements de Caisse</h6>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr class="small text-muted text-uppercase">
                        <th>Type</th>
                        <th>Motif</th>
                        <th class="text-end">Montant</th>
                        <th class="text-end no-print">Action</th>
                    </tr>
                </thead>
                <tbody id="withdrawLogs" class="small"></tbody>
            </table>
        </div>
    </section>

    <div id="printFooter">
        <div class="row">
            <div class="col-8">
                <small class="text-muted">Rapport financier généré automatiquement par B-ONE System le : <span id="currentPrintDate"></span></small>
            </div>
            <div class="col-4 text-center">
                <p class="mb-1 fw-bold text-decoration-underline">Le Président Directeur Général</p>
                <div style="height: 60px;"></div>
                <p class="fw-bold mb-0" id="ceoPrint">Atizoun Plateny AMOUSSOU</p>
                <small class="text-muted">Cachet et Signature</small>
            </div>
        </div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB4Ov3DGVvFuR9c1EGA8Gt-KOsZRLJlQXc",
        authDomain: "gestion-importation-et-vente.firebaseapp.com",
        databaseURL: "https://gestion-importation-et-vente-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "gestion-importation-et-vente",
        storageBucket: "gestion-importation-et-vente.firebasestorage.app",
        messagingSenderId: "243102213554",
        appId: "1:243102213554:web:64d745f547b5b59b8430ab"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const APP_PREFIX = 'BONE_'; 
    const DB_PATH = 'data_sync/';

    const nativeSetItem = localStorage.setItem;
    localStorage.setItem = function(key, value) {
        try {
            nativeSetItem.apply(this, arguments);
        } catch (e) {
            console.warn("LocalStorage saturé.");
        }

        if (key.startsWith(APP_PREFIX)) {
            const path = key.replace(APP_PREFIX, '');
            const dbRef = ref(db, DB_PATH + path); 
            try {
                const data = JSON.parse(value);
                set(dbRef, data);
            } catch (e) {
                set(dbRef, value);
            }
        }
    };

    window.initCloudSync = function(refreshCallback) {
        const dataRef = ref(db, DB_PATH);
        onValue(dataRef, (snapshot) => {
            const cloudData = snapshot.val();
            if (!cloudData) return;

            let hasChanged = false;
            Object.keys(cloudData).forEach(path => {
                const localKey = APP_PREFIX + path;
                const cloudValueStr = (typeof cloudData[path] === 'object') 
                                      ? JSON.stringify(cloudData[path]) 
                                      : cloudData[path];
                
                if (localStorage.getItem(localKey) !== cloudValueStr) {
                    nativeSetItem.call(localStorage, localKey, cloudValueStr);
                    hasChanged = true;
                }
            });
            
            if (hasChanged && typeof refreshCallback === 'function') {
                refreshCallback();
            }
        });
    };

    window.initCloudSync(() => {
        if (typeof Finance !== 'undefined') Finance.renderAccounting();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const sessionLocal = JSON.parse(localStorage.getItem('BONE_USER_SESSION'));
    if (!sessionLocal || sessionLocal.role !== 'admin') {
        window.location.href = 'login.html';
    }

    const STORAGE_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const ORDERS_KEY = 'BONE_ORDERS_HISTORY'; 
    const FLUX_KEY = 'BONE_FINANCE_FLUX'; 
    const DB_KEY = 'BONE_PRODUCTS_LIST'; 

    let financeFlux = [];
    let myChart = null;

    const Finance = {
        init() {
            this.loadBranding();
            document.getElementById('currentPrintDate').innerText = new Date().toLocaleString('fr-FR');
            this.renderAccounting();
        },

        loadBranding() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(config) {
                if(config.companyName) {
                    document.getElementById('navCompanyName').innerText = config.companyName;
                    document.getElementById('printTitle').innerText = config.companyName;
                }
                if(config.ceoName) document.getElementById('ceoPrint').innerText = config.ceoName;
                if(config.logo) document.getElementById('navLogo').src = config.logo;
            }
        },

        toggleChart() {
            const wrapper = document.getElementById('chartWrapper');
            const btn = document.getElementById('toggleChartBtn');
            if(wrapper.style.display === 'block') {
                wrapper.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-graph-up me-2"></i>Afficher le graphique d\'évolution';
            } else {
                wrapper.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-eye-slash me-2"></i>Masquer le graphique';
                this.renderAccounting(); 
            }
        },

        addWithdraw(type) {
            const amtId = type === 'profit' ? 'outProfitAmt' : 'outCapAmt';
            const motifId = type === 'profit' ? 'outProfitMotif' : 'outCapMotif';
            const amount = parseFloat(document.getElementById(amtId).value);
            const motif = document.getElementById(motifId).value;

            if(!amount || !motif) return alert("Veuillez remplir le montant et le motif");

            financeFlux = JSON.parse(localStorage.getItem(FLUX_KEY)) || [];
            financeFlux.push({
                id: Date.now(),
                type: type,
                amount: amount,
                motif: motif,
                date: new Date().toLocaleDateString('fr-FR'),
                timestamp: Date.now()
            });

            localStorage.setItem(FLUX_KEY, JSON.stringify(financeFlux));
            document.getElementById(amtId).value = '';
            document.getElementById(motifId).value = '';
            this.showToast("Mouvement enregistré");
            this.renderAccounting();
        },

        deleteWithdraw(id) {
            if(confirm("Supprimer cette opération financière ?")) {
                financeFlux = JSON.parse(localStorage.getItem(FLUX_KEY)) || [];
                financeFlux = financeFlux.filter(f => f.id !== id);
                localStorage.setItem(FLUX_KEY, JSON.stringify(financeFlux));
                this.renderAccounting();
            }
        },

        showToast(msg) {
            const t = document.getElementById('successMessage');
            t.innerHTML = `<div class="success-toast shadow-lg">${msg}</div>`;
            setTimeout(() => t.innerHTML = '', 3000);
        },

        renderAccounting() {
            const userOrders = JSON.parse(localStorage.getItem(ORDERS_KEY)) || [];
            const catalog = JSON.parse(localStorage.getItem(DB_KEY)) || [];
            financeFlux = JSON.parse(localStorage.getItem(FLUX_KEY)) || [];
            
            const period = document.getElementById('periodFilter').value;
            const growthRate = parseFloat(document.getElementById('growthRate').value) / 100 || 0;
            const table = document.getElementById('accountingTable');
            
            let stats = { sales: 0, acq: 0, growth: 0, gross: 0, outProfit: 0, outCap: 0 };
            let chartData = {};

            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const dayOfWeek = now.getDay() || 7; 
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (dayOfWeek - 1)).getTime();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            const startOfYear = new Date(now.getFullYear(), 0, 1).getTime();

            const filteredOrders = userOrders.filter(o => {
                const oTime = o.timestamp ? new Date(o.timestamp).getTime() : 0;
                if (period === 'all') return true;
                if (period === 'day') return oTime >= startOfDay;
                if (period === 'week') return oTime >= startOfWeek;
                if (period === 'month') return oTime >= startOfMonth;
                if (period === 'year') return oTime >= startOfYear;
                return true;
            });

            table.innerHTML = filteredOrders.map((order) => {
                const productInCatalog = catalog.find(p => p.id === order.prodId || p.name === order.prodName);
                let unitAcquisition = order.acquisitionPrice && parseFloat(order.acquisitionPrice) > 0 ? parseFloat(order.acquisitionPrice) : (productInCatalog?.priceBuy || order.rawPrice || 0);
                const quantity = parseInt(order.qty || order.quantity) || 1;
                const acqTotal = unitAcquisition * quantity;
                
                // --- MISE À JOUR INTELLIGENTE DU CALCUL DU PAYÉ ---
                // On privilégie 'paymentReceived' qui est la somme totale enregistrée dans le suivi des paiements
                let payedAmount = 0;
                if (order.paymentReceived !== undefined) {
                    payedAmount = parseFloat(order.paymentReceived);
                } else {
                    // Fallback sur le calcul par drapeaux si paymentReceived est absent
                    const priceVal = (order.isPricePayed ? (parseFloat(order.price) || 0) : 0);
                    const transitVal = (order.isTransitPayed ? (parseFloat(order.transit) || 0) : 0);
                    const douaneVal = (order.isDouanePayed ? (parseFloat(order.douane) || 0) : 0);
                    const livraisonVal = (order.isLivraisonPayed ? (parseFloat(order.livraison) || 0) : 0);
                    payedAmount = (priceVal + transitVal + douaneVal + livraisonVal) * quantity;
                }
                
                const growth = acqTotal * growthRate;
                // La marge réelle est calculée sur ce qui a été effectivement encaissé moins le capital et l'épargne croissance
                const profit = payedAmount - acqTotal - growth;

                stats.sales += payedAmount; stats.acq += acqTotal; stats.growth += growth; stats.gross += profit;
                const dateStr = order.timestamp ? new Date(order.timestamp).toLocaleDateString('fr-FR') : '-';
                if(dateStr !== '-') chartData[dateStr] = (chartData[dateStr] || 0) + profit;

                return `<tr><td class="text-muted" style="font-size: 0.7rem;">${dateStr}</td><td><div class="fw-bold">${order.prodName}</div><div class="text-muted small">${order.client} (Qté: ${quantity})</div></td><td class="text-center fw-bold">${payedAmount.toLocaleString()}</td><td class="text-center"><input type="number" class="input-acquisition" value="${acqTotal}" readonly></td><td class="text-center text-info fw-bold">${Math.round(growth).toLocaleString()}</td><td class="text-end ${profit >= 0 ? 'benefit-positive' : 'benefit-negative'}">${Math.round(profit).toLocaleString()}</td><td class="text-end no-print"><i class="bi bi-lock-fill text-muted"></i></td></tr>`;
            }).reverse().join('');

            const filteredFlux = financeFlux.filter(f => {
                const fTime = f.timestamp || 0;
                if (period === 'all') return true;
                if (period === 'day') return fTime >= startOfDay;
                if (period === 'week') return fTime >= startOfWeek;
                if (period === 'month') return fTime >= startOfMonth;
                if (period === 'year') return fTime >= startOfYear;
                return true;
            });

            document.getElementById('withdrawLogs').innerHTML = filteredFlux.map(f => {
                if(f.type === 'profit') stats.outProfit += f.amount; else stats.outCap += f.amount;
                return `<tr><td><span class="badge ${f.type==='profit'?'bg-danger':'bg-warning text-dark'}">${f.type.toUpperCase()}</span></td><td>${f.motif} <br><small class="text-muted">${f.date}</small></td><td class="text-end fw-bold">-${f.amount.toLocaleString()}</td><td class="text-end no-print"><button class="btn btn-sm text-muted" onclick="Finance.deleteWithdraw(${f.id})"><i class="bi bi-trash"></i></button></td></tr>`;
            }).join('');

            document.getElementById('totalSales').innerText = `${Math.round(stats.sales).toLocaleString()} F`;
            document.getElementById('totalCapitalStock').innerText = `${Math.round(stats.acq).toLocaleString()} F`;
            document.getElementById('totalGrowthSaving').innerText = `${Math.round(stats.growth).toLocaleString()} F`;
            document.getElementById('totalGrossProfit').innerText = `${Math.round(stats.gross).toLocaleString()} F`;
            document.getElementById('totalWithdrawProfit').innerText = `-${stats.outProfit.toLocaleString()} F`;
            document.getElementById('remainingProfit').innerText = `${Math.round(stats.gross - stats.outProfit).toLocaleString()} F`;
            document.getElementById('theoreticalCapital').innerText = `${Math.round(stats.acq + stats.growth).toLocaleString()} F`;
            document.getElementById('totalWithdrawCapital').innerText = `-${stats.outCap.toLocaleString()} F`;
            document.getElementById('remainingCapital').innerText = `${Math.round(stats.acq + stats.growth - stats.outCap).toLocaleString()} F`;

            if(document.getElementById('chartWrapper').style.display === 'block') this.updateChart(chartData);
        },

        updateChart(data) {
            const ctx = document.getElementById('evolutionChart').getContext('2d');
            if(myChart) myChart.destroy();
            const labels = Object.keys(data).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            const values = labels.map(label => data[label]);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{ 
                        label: 'Marge Réelle', data: values, borderColor: '#7d2ae8', tension: 0.3, fill: true, backgroundColor: 'rgba(125, 42, 232, 0.05)', pointRadius: 3 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        },
        printPDF() { window.print(); }
    };

    window.onload = () => Finance.init();

    function logout() {
        if (confirm("Atizoun, voulez-vous vraiment vous déconnecter ?")) {
            localStorage.removeItem('BONE_USER_SESSION');
            window.location.href = 'login.html';
        }
    }
</script>

<button onclick="logout()" class="btn btn-danger position-fixed bottom-0 end-0 m-3 rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; z-index: 2000; border: 2px solid white;">
    <i class="bi bi-power fs-4"></i>
</button>

</body>
</html>
