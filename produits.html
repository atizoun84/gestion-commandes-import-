<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT & B-One | Catalogue Produits</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MT & B-One">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192">
    
    <meta name="theme-color" content="#7d2ae8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { 
            --canva-purple: #7d2ae8; 
            --canva-blue: #00c4cc; 
            --canva-gradient: linear-gradient(135deg, #7d2ae8 0%, #00c4cc 100%);
        }
        
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        
        /* Header & Navbar */
        .app-header { background: var(--canva-gradient); color: white; padding: 0.5rem 0; }
        .header-logo { height: 45px; width: 45px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.2); padding: 3px; }
        
        .navbar-dark .navbar-nav .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; font-size: 0.9rem; }
        .navbar-dark .navbar-nav .nav-link:hover { color: #fff !important; }
        .navbar-toggler { border: none; padding: 0; }
        .navbar-toggler:focus { box-shadow: none; }

        /* Barre de Recherche */
        .search-container { margin-top: -25px; position: relative; font-size: 1rem; z-index: 10; }
        .search-input { 
            border-radius: 30px; border: none; padding: 15px 25px 15px 50px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); font-size: 1rem;
        }
        .search-icon { position: absolute; left: 20px; top: 15px; color: #888; font-size: 1.2rem; }

        /* Filtres Catégories */
        .category-scroll { display: flex; overflow-x: auto; gap: 10px; padding: 15px 0; scrollbar-width: none; }
        .category-scroll::-webkit-scrollbar { display: none; }
        .cat-badge { 
            white-space: nowrap; padding: 8px 20px; border-radius: 20px; 
            background: white; color: #555; font-weight: 600; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid transparent;
            display: flex; align-items: center; gap: 5px;
        }
        .cat-badge.active { background: var(--canva-purple); color: white; }
        .btn-del-cat { font-size: 0.7rem; opacity: 0.6; }
        .btn-del-cat:hover { opacity: 1; color: #ff3b30; }

        /* Grille Produits */
        .product-card { 
            border: none; border-radius: 20px; overflow: hidden; 
            transition: 0.3s; background: white; height: 100%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); cursor: pointer;
        }
        .product-card:hover { transform: translateY(-5px); }
        .img-container { height: 180px; background: #f8f8f8; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .product-img { max-width: 80%; max-height: 80%; object-fit: contain; }
        
        .price-tag { color: var(--canva-purple); font-weight: 800; font-size: 1.1rem; }
        .btn-edit-prod, .btn-cart-prod { 
            width: 36px; height: 36px; border-radius: 10px; 
            background: #f0f0f0; color: #555; 
            display: flex; align-items: center; justify-content: center; border: none;
            transition: 0.2s;
        }
        .btn-edit-prod:hover { background: var(--canva-blue); color: white; }
        .btn-cart-prod:hover { background: #25D366; color: white; }

        /* Modales */
        .modal-content { border-radius: 30px; border: none; }
        #captureArea { padding: 30px; background: white; border-radius: 25px; position: relative; }
        .modal-product-img { max-width: 100%; height: 200px; object-fit: contain; margin-bottom: 15px; display: block; margin-left: auto; margin-right: auto; }
        
        .marketing-banner { background: var(--canva-gradient); color: white; border-radius: 12px; padding: 10px; margin-bottom: 20px; font-size: 0.8rem; font-weight: 600; }
        .order-info { border-top: 1px solid #eee; margin-top: 15px; padding-top: 15px; font-size: 0.85rem; }
        .modal-signature { max-height: 50px; margin-top: 5px; filter: contrast(1.1); }

        .share-btn-img { background: #25D366; color: white; border-radius: 30px; padding: 12px 25px; font-weight: 700; border: none; transition: 0.3s; margin-bottom: 10px; }
        .share-btn-link { background: var(--canva-purple); color: white; border-radius: 30px; padding: 12px 25px; font-weight: 700; border: none; transition: 0.3s; margin-bottom: 10px; }
        .share-btn-status { background: #00c4cc; color: white; border-radius: 30px; padding: 12px 25px; font-weight: 700; border: none; transition: 0.3s; margin-bottom: 10px; }
        .share-btn-status:hover, .share-btn-img:hover, .share-btn-link:hover { opacity: 0.9; }
        .btn-close-modal { background: #6c757d; color: white; border-radius: 30px; padding: 12px 25px; font-weight: 700; border: none; transition: 0.3s; margin-bottom: 10px; }

        /* Boutons Flottants */
        .btn-plus-float { position: fixed; bottom: 90px; right: 20px; width: 60px; height: 60px; border-radius: 30px; background: var(--canva-blue); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(0, 196, 204, 0.4); z-index: 1000; border: none; }

        .admin-section { background: white; border-radius: 20px; padding: 20px; margin-top: 40px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .canal-box { border: 1px solid #eee; border-radius: 15px; padding: 10px; margin-bottom: 10px; background: #fafafa; }
        
        .highlight-new { animation: pulse-border 2s ease-in-out; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--canva-purple); }
            50% { box-shadow: 0 0 0 10px rgba(125, 42, 232, 0.2); }
            100% { box-shadow: 0 0 0 0px transparent; }
        }
        .price-detail-box { font-size: 0.75rem; color: #777; background: #fdfdfd; padding: 5px 10px; border-radius: 8px; margin-top: 2px; }
        .product-qualities { font-size: 0.8rem; color: #555; font-style: italic; margin-bottom: 10px; }
        .stock-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 12px; border-radius: 10px; margin-top: 5px; display: inline-block; }

        /* Style spécifique Order Modal */
        .order-modal-header { background: var(--canva-gradient); color: white; border-radius: 30px 30px 0 0; padding: 20px; position: relative; }
        .order-summary-table { font-size: 0.85rem; border-radius: 15px; overflow: hidden; }
        .order-summary-table th { background: #f8f9fa; color: #555; }
        .order-status-banner { border-radius: 15px; padding: 15px; font-weight: bold; text-align: center; margin-top: 15px; }
        .order-price-row input { border: none; background: #f0f0f0; border-radius: 5px; width: 60px; text-align: center; font-size: 0.8rem; }
        .order-price-row .form-check-input { cursor: pointer; width: 1.2em; height: 1.2em; border: 2px solid var(--canva-purple); }

        /* Animation de succès */
        .success-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .success-checkmark { width: 100px; height: 100px; border-radius: 50%; display: block; stroke-width: 2; stroke: #4bb543; stroke-miterlimit: 10; margin: 10% auto; box-shadow: inset 0px 0px 0px #4bb543; animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both; }
        .success-checkmark-circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 2; stroke-miterlimit: 10; stroke: #4bb543; fill: none; animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .success-checkmark-check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
        @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 50px #4bb543; } }
        
        /* Utilitaires pour rôles */
        .admin-only { display: none; }
        .user-only { display: block; }
    </style>
</head>
<body>

<div id="successOverlay" class="success-overlay">
    <svg class="success-checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
      <circle class="success-checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
      <path class="success-checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
    </svg>
    <h3 class="fw-bold text-dark mt-3">PROJET VALIDÉ !</h3>
    <p class="text-muted">Redirection vers votre panier...</p>
</div>

<header class="app-header shadow-lg pb-4">
    <nav class="navbar navbar-expand-lg navbar-dark p-3">
        <div class="container px-0">
            <div class="d-flex align-items-center gap-2">
                <img id="navLogo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="header-logo" alt="">
                <div>
                    <h1 class="h6 fw-bold mb-0 text-white" id="navCompanyName">MT & B-One</h1>
                    <small class="opacity-75" style="font-size: 0.65rem;">Catalogue Officiel</small>
                </div>
            </div>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <i class="bi bi-list fs-2"></i>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                    <li class="nav-item nav-home"><a class="nav-link" href="index.html"><i class="bi bi-house-door me-1"></i> Accueil</a></li>
                    <li class="nav-item nav-products"><a class="nav-link active" href="produits.html"><i class="bi bi-box-seam me-1"></i> Produits</a></li>
                    <li class="nav-item nav-cart"><a class="nav-link" href="panier.html"><i class="bi bi-cart3 me-1"></i> Mon Panier</a></li>
                    <li class="nav-item nav-pay"><a class="nav-link" href="paiement.html"><i class="bi bi-credit-card me-1"></i> Paiement</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" href="comptabilite.html"><i class="bi bi-calculator me-1"></i> Comptabilité</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" href="maintenance.html"><i class="bi bi-wrench-adjustable me-1"></i> Maintenance</a></li>
                    <li class="nav-item admin-only"><a class="nav-link" href="configuration.html"><i class="bi bi-gear me-1"></i> Configuration</a></li>
                    <li class="nav-item border-start ms-lg-2 ps-lg-2 nav-logout">
                        <a class="nav-link text-warning fw-bold" href="javascript:void(0)" onclick="Shop.logout()">
                            <i class="bi bi-power me-1"></i> Déconnecter
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container px-4">
    <div class="search-container">
        <i class="bi bi-search search-icon"></i>
        <input type="text" id="searchInput" class="form-control search-input" placeholder="Rechercher un produit..." onkeyup="Shop.search()">
    </div>

    <div class="category-scroll" id="categoryTabs">
        <div class="cat-badge active" onclick="Shop.filter('Tous', this)">Tous</div>
    </div>

    <div class="row g-3" id="productGrid"></div>

    <section class="admin-section mb-5 admin-only" id="adminPanel">
        <h2 class="h5 fw-bold mb-4"><i class="bi bi-gear-fill me-2"></i>Gestion Administrative</h2>
        
        <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#adminProds">Produits</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#adminOrders">Historique Commandes</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="adminProds">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" style="font-size: 0.85rem;">
                        <thead class="table-light">
                            <tr>
                                <th>Réf</th>
                                <th>Produit</th>
                                <th>Stock</th>
                                <th>Canaux</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminProductTable"></tbody>
                    </table>
                </div>
            </div>
            <div class="tab-pane fade" id="adminOrders">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" style="font-size: 0.85rem;">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Produit</th>
                                <th>Total</th>
                                <th>Statut</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminOrdersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
</main>

<button class="btn-plus-float shadow-lg admin-only" id="btnFloatAdd" onclick="Shop.openAddModal()" title="Ajouter un produit">
    <i class="bi bi-plus-lg fs-3"></i>
</button>

<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0">
            <div class="order-modal-header text-center">
                <h5 class="fw-bold mb-0 text-uppercase letter-spacing-1">Validation du Projet de Commande</h5>
                <button type="button" class="btn-close btn-close-white position-absolute end-0 top-0 m-3" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-5 text-center border-end">
                        <img id="orderProdImg" src="" class="img-fluid rounded-3 mb-3" style="max-height: 200px;">
                        <h6 id="orderProdName" class="fw-bold text-primary"></h6>
                        <div id="orderProdRef" class="small text-muted mb-2"></div>
                        <div id="orderProdStockBadge"></div>
                    </div>
                    <div class="col-md-7">
                        <form id="orderForm">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">NOM DU CLIENT *</label>
                                    <input type="text" id="orderClientName" class="form-control rounded-pill" placeholder="Ex: Jean Dupont" required>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">TÉLÉPHONE *</label>
                                    <input type="tel" id="orderClientPhone" class="form-control rounded-pill" placeholder="Ex: 0102030405" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold text-muted">SÉLECTIONNEZ LE TARIF APPLICABLE</label>
                                <div class="table-responsive">
                                    <table class="table table-bordered order-summary-table align-middle">
                                        <thead>
                                            <tr class="text-center">
                                                <th>Canal</th>
                                                <th>Vente</th>
                                                <th>Transit</th>
                                                <th>Douane</th>
                                                <th>Livr.</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="orderPriceTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">QUANTITÉ</label>
                                    <input type="number" id="orderQty" class="form-control rounded-pill" value="1" min="1" oninput="Shop.calculateOrder()">
                                    <div id="orderMinQtyHint" class="text-danger fw-bold mt-1" style="font-size: 0.7rem; display: none;"></div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">PRIX UNITAIRE FINAL</label>
                                    <input type="number" id="orderCustomPrice" class="form-control rounded-pill" placeholder="20000" oninput="Shop.calculateOrder()">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small fw-bold">MONTANT DU PAIEMENT REÇU</label>
                                <div class="input-group">
                                    <input type="number" id="orderPayment" class="form-control rounded-start-pill" placeholder="Saisir le montant versé" oninput="Shop.calculateOrder()">
                                    <span class="input-group-text rounded-end-pill">F CFA</span>
                                </div>
                            </div>

                            <div id="orderTotalDisplay" class="p-3 bg-light rounded-4 mb-3 text-center">
                                <span class="text-muted small">TOTAL À PAYER :</span>
                                <h4 class="fw-bold text-dark mb-0" id="valTotal">0 F CFA</h4>
                            </div>

                            <div id="orderStatusBanner" class="order-status-banner" style="display:none;"></div>

                            <button type="button" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow mt-3" onclick="Shop.validateProject()">
                                <i class="bi bi-check2-circle me-2"></i>VALIDER LE PROJET
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="fw-bold"><i class="bi bi-box-seam-fill me-2 text-primary"></i>Configuration Produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="addProductForm">
                    <input type="hidden" id="editProductId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">NOM DU PRODUIT</label>
                            <input type="text" id="pName" class="form-control rounded-pill" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">CATÉGORIE</label>
                            <div class="input-group">
                                <select id="pCat" class="form-select rounded-start-pill" required></select>
                                <button class="btn btn-primary rounded-end-pill" type="button" onclick="Shop.addNewCategory()"><i class="bi bi-plus-lg"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold">QUALITÉS / POINTS FORTS</label>
                            <textarea id="pQualities" class="form-control rounded-4" rows="2" placeholder="Ex: Autonomie 24h, Étanche IP67, Charge rapide..."></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">STOCK DISPONIBLE</label>
                            <input type="number" id="pStock" class="form-control rounded-pill" placeholder="0 = Sur commande">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                             <label class="form-label small fw-bold text-primary">QUANTITÉ MINIMUM COMMANDE</label>
                             <input type="number" id="pMinQty" class="form-control rounded-pill" placeholder="Ex: 1" value="1" min="1">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Prix d'Achat Brut (Capital unité)</label>
                            <input type="number" id="pPriceBuy" class="form-control rounded-pill bg-light" placeholder="Ex: 5000" required>
                        </div>
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Devise</label>
                            <select id="pCurrency" class="form-select rounded-pill">
                                <option value="F CFA">F CFA</option>
                                <option value="€">€</option>
                                <option value="$">$</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Pays d'Origine</label>
                            <div class="input-group">
                                <select id="pOrigin" class="form-select rounded-start-pill"></select>
                                <button class="btn btn-outline-secondary rounded-end-pill" type="button" onclick="Shop.addNewOrigin()"><i class="bi bi-plus"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="canal-box">
                                <h6 class="fw-bold text-primary mb-2"><i class="bi bi-airplane"></i> AVION</h6>
                                <input type="number" id="pAvionVente" class="form-control form-control-sm mb-1" placeholder="Prix Vente">
                                <input type="number" id="pAvionTransit" class="form-control form-control-sm mb-1" placeholder="Transit">
                                <input type="number" id="pAvionDouane" class="form-control form-control-sm mb-1" placeholder="Douane">
                                <input type="number" id="pAvionLiv" class="form-control form-control-sm" placeholder="Livraison">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="canal-box">
                                <h6 class="fw-bold text-info mb-2"><i class="bi bi-ship"></i> BATEAU</h6>
                                <input type="number" id="pBateauVente" class="form-control form-control-sm mb-1" placeholder="Prix Vente">
                                <input type="number" id="pBateauTransit" class="form-control form-control-sm mb-1" placeholder="Transit">
                                <input type="number" id="pBateauDouane" class="form-control form-control-sm mb-1" placeholder="Douane">
                                <input type="number" id="pBateauLiv" class="form-control form-control-sm" placeholder="Livraison">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="canal-box">
                                <h6 class="fw-bold text-success mb-2"><i class="bi bi-shop"></i> DIRECT (Magasin)</h6>
                                <input type="number" id="pDirectTTC" class="form-control form-control-sm mb-2" placeholder="Prix TTC Final">
                                <hr class="my-2">
                                <label class="small fw-bold text-muted">OPTION GROS</label>
                                <input type="number" id="pGrosTTC" class="form-control form-control-sm mb-1" placeholder="Prix TTC Gros">
                                <input type="number" id="pGrosQty" class="form-control form-control-sm" placeholder="Qté min. pour gros">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3 mt-2">
                        <label class="form-label small fw-bold">Image</label>
                        <input type="file" id="pImgFile" class="form-control rounded-pill" accept="image/*">
                        <input type="hidden" id="pImgBase64">
                    </div>
                    <button type="submit" id="btnSaveMain" class="btn btn-primary w-100 py-3 shadow rounded-pill fw-bold">ENREGISTRER</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-body p-0">
                <div id="captureArea" class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                         <img id="modalBrandLogo" src="" style="height: 40px; width: 40px; object-fit: contain; border-radius: 8px;">
                         <div class="text-start">
                             <div class="fw-bold text-dark" style="font-size: 0.9rem;" id="modalCompanyName">MT & B-One</div>
                             <div class="text-muted" style="font-size: 0.65rem;">Catalogue Officiel</div>
                         </div>
                    </div>
                    <div class="marketing-banner">TARIFICATION PAR CANAL</div>
                    <img id="modalImg" src="" class="modal-product-img">
                    <h3 id="modalTitle" class="fw-bold text-dark mb-1"></h3>
                    <div id="modalWaveNumber" class="badge bg-dark text-white mb-1" style="font-size: 0.7rem; display: none;"></div>
                    <div id="modalQualities" class="product-qualities px-4"></div>
                    <div id="modalUniqueIdDisplay" class="fw-bold text-primary mb-1" style="font-size: 1.1rem; letter-spacing: 1px;"></div>
                    <div id="modalStockDisplay" class="mb-2"></div>
                    <div id="modalOrigin" class="small text-muted mb-2"></div>
                    <div id="modalPriceList" class="px-3 mb-3"></div>
                    <div class="order-info">
                        <div class="row align-items-center">
                            <div class="col-7 text-start ps-4">
                                <p class="mb-0 fw-bold" id="modalDisplayCEOName" style="font-size: 0.8rem;">PDG : ...</p>
                                <p class="mb-0 text-muted" id="modalDisplayCEOPhone" style="font-size: 0.75rem;">...</p>
                            </div>
                            <div class="col-5"><img id="modalSignature" src="" class="modal-signature"></div>
                        </div>
                    </div>
                </div>
                <div class="p-4 pt-0 text-center">
                    <input type="hidden" id="currentProductId">
                    <button class="share-btn-status w-100" onclick="Shop.publishToStatus()"><i class="bi bi-whatsapp me-2"></i>PUBLIER SUR WHATSAPP</button>
                    <button class="share-btn-img w-100" onclick="Shop.shareProductImg()"><i class="bi bi-image me-2"></i>Télécharger l'affiche</button>
                    <button class="share-btn-link w-100" onclick="Shop.shareProductLink()"><i class="bi bi-whatsapp me-2"></i>Commander via WhatsApp</button>
                    <button class="btn-close-modal w-100" data-bs-dismiss="modal"><i class="bi bi-x-circle me-2"></i>FERMER LA FICHE</button>
                    <button id="modalBtnDelete" class="btn btn-outline-danger w-100 mt-2 border-0 admin-only" onclick="Shop.deleteCurrentProduct()">
                        <i class="bi bi-trash3 me-2"></i>Supprimer définitivement ce produit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // --- IMPORTATION FIREBASE ---
    import { db, ref, set, onValue, remove, sendNotification } from './firebase-config.js';

    const session = JSON.parse(localStorage.getItem('BONE_USER_SESSION'));
    if (!session) window.location.href = 'login.html';

    function appliquerRestrictions() {
        const sessionActualisee = JSON.parse(localStorage.getItem('BONE_USER_SESSION'));
        if (sessionActualisee && sessionActualisee.role === 'user') {
            const addBtn = document.querySelector('[data-bs-target="#addProductModal"], #addProductBtn, #btnFloatAdd');
            if (addBtn) addBtn.style.display = 'none';

            const actionButtons = document.querySelectorAll('.bi-pencil, .bi-pencil-square, .bi-trash, .bi-trash3, .btn-outline-danger, .btn-outline-primary, .btn-edit-prod');
            actionButtons.forEach(btn => {
                if (!btn.classList.contains('bi-cart-plus')) {
                    btn.parentElement.style.display = 'none'; 
                }
            });

            const adminLinks = document.querySelectorAll('a[href="comptabilite.html"], a[href="configuration.html"], a[href="maintenance.html"]');
            adminLinks.forEach(link => link.style.display = 'none');
        }
    }

    const STORAGE_KEY = 'BONE_OFFICIAL_CONFIG_V2';
    const CAT_KEY = 'BONE_CATEGORIES_LIST';
    const ORIGIN_KEY = 'BONE_ORIGINS_LIST';
    const SESSION_KEY = 'BONE_USER_SESSION';
    const ORDERS_KEY = 'BONE_ORDERS_HISTORY';

    let products = [];
    let categories = JSON.parse(localStorage.getItem(CAT_KEY)) || ['Énergie', 'Audio', 'Mobilité'];
    let origins = JSON.parse(localStorage.getItem(ORIGIN_KEY)) || ['Chine', 'Dubaï', 'USA', 'Europe'];
    let orders = JSON.parse(localStorage.getItem(ORDERS_KEY)) || [];

    const Shop = {
        currentOrderProduct: null,
        selectedPrices: [],
        isAdmin: false,

        init() {
            this.checkSession();
            this.renderCategories();
            this.renderOrigins();
            this.loadBrandConfig();
            
            // ÉCOUTE FIREBASE EN TEMPS RÉEL (Correctif chargement instantané)
            onValue(ref(db, 'produits'), (snapshot) => {
                const data = snapshot.val();
                products = data ? Object.values(data) : [];
                this.render();
                if(this.isAdmin) {
                    this.renderAdminTable();
                    this.renderOrdersTable();
                }
                appliquerRestrictions();
            });
        },

        checkSession() {
            const sessionData = JSON.parse(localStorage.getItem(SESSION_KEY));
            if (!sessionData) {
                window.location.href = 'login.html';
                return;
            }
            this.isAdmin = (sessionData.role === 'admin');
            
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.setProperty('display', this.isAdmin ? 'block' : 'none', 'important');
            });

            if(!this.isAdmin) {
                document.querySelector('.nav-home')?.style.setProperty('display', 'none', 'important');
                document.querySelector('.nav-cart')?.style.setProperty('display', 'none', 'important');
                document.querySelector('.nav-pay')?.style.setProperty('display', 'none', 'important');
            }
        },

        logout() {
            localStorage.removeItem(SESSION_KEY);
            window.location.href = 'login.html';
        },

        loadBrandConfig() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY));
            if(config) {
                if(config.logo) {
                    document.getElementById('navLogo').src = config.logo;
                    document.getElementById('modalBrandLogo').src = config.logo;
                }
                if(config.companyName) {
                    document.getElementById('navCompanyName').innerText = config.companyName;
                    document.getElementById('modalCompanyName').innerText = config.companyName;
                }
                if(config.ceoName) document.getElementById('modalDisplayCEOName').innerText = "PDG : " + config.ceoName;
                if(config.ceoWhatsapp) document.getElementById('modalDisplayCEOPhone').innerText = config.ceoWhatsapp;
                if(config.sign) document.getElementById('modalSignature').src = config.sign;
            }
        },

        renderCategories() {
            const tabs = document.getElementById('categoryTabs');
            const select = document.getElementById('pCat');
            
            tabs.innerHTML = `<div class="cat-badge active" onclick="Shop.filter('Tous', this)">Tous</div>` + 
                categories.map(c => `
                    <div class="cat-badge" onclick="Shop.filter('${c}', this)">
                        ${c}
                        ${this.isAdmin ? `<i class="bi bi-x-circle btn-del-cat" onclick="event.stopPropagation(); Shop.deleteCategory('${c}')"></i>` : ''}
                    </div>`).join('');
            if(select) select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
        },

        addNewCategory() {
            const newCat = prompt("Nom de la catégorie :");
            if(newCat && !categories.includes(newCat)) { categories.push(newCat); localStorage.setItem(CAT_KEY, JSON.stringify(categories)); this.renderCategories(); }
        },

        deleteCategory(cat) {
            if(confirm(`Supprimer la catégorie "${cat}" ?`)) {
                categories = categories.filter(c => c !== cat);
                localStorage.setItem(CAT_KEY, JSON.stringify(categories));
                this.renderCategories();
            }
        },

        renderOrigins() {
            const select = document.getElementById('pOrigin');
            if(select) select.innerHTML = origins.map(o => `<option value="${o}">${o}</option>`).join('');
        },

        addNewOrigin() {
            const newOri = prompt("Nom du nouveau pays d'origine :");
            if(newOri && !origins.includes(newOri)) { origins.push(newOri); localStorage.setItem(ORIGIN_KEY, JSON.stringify(origins)); this.renderOrigins(); document.getElementById('pOrigin').value = newOri; }
        },

        getRemainingMinQty(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return 0;
            const wave = product.currentWave || 1;
            const totalOrderedInWave = orders
                .filter(o => o.prodId === productId && o.wave === wave)
                .reduce((sum, o) => sum + (parseInt(o.qty) || 0), 0);
            const remaining = (parseInt(product.minQty) || 1) - totalOrderedInWave;
            return remaining > 0 ? remaining : 0;
        },

        render(items = products) {
            const grid = document.getElementById('productGrid');
            if(!grid) return;
            grid.innerHTML = items.map(p => {
                let displayPrice = "N/D";
                if(p.canaux) {
                    if(p.canaux.direct?.ttc) displayPrice = p.canaux.direct.ttc.toLocaleString();
                    else if(p.canaux.avion?.vente) displayPrice = (p.canaux.avion.vente + p.canaux.avion.transit + p.canaux.avion.douane + p.canaux.avion.liv).toLocaleString();
                }

                const wave = p.currentWave || 1;
                const totalOrderedInWave = orders.filter(o => o.prodId === p.id && o.wave === wave).reduce((sum, o) => sum + (parseInt(o.qty) || 0), 0);
                const minTarget = parseInt(p.minQty) || 1;
                const ratioDisplay = minTarget > 1 ? `<div class="badge bg-light text-dark border mt-1" style="font-size:0.65rem;">Seuil: ${totalOrderedInWave}/${minTarget} (V${wave})</div>` : "";

                return `
                <div class="col-6 col-md-4 col-lg-3 mb-3" id="prod-card-${p.id}">
                    <div class="product-card shadow-sm p-3" onclick="Shop.showDetails(${p.id})">
                        <div class="img-container mb-2">
                            <img src="${p.img}" class="product-img" loading="lazy">
                        </div>
                        <h3 class="h6 fw-bold text-dark mb-1 text-truncate">${p.name}</h3>
                        <div class="mb-1">${ratioDisplay}</div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="price-tag">${displayPrice} ${p.currency || 'F CFA'}</span>
                            <div class="d-flex gap-1">
                                <button class="btn-cart-prod" onclick="event.stopPropagation(); Shop.openOrderModal(${p.id})"><i class="bi bi-cart-plus"></i></button>
                                ${this.isAdmin ? `<button class="btn-edit-prod" onclick="event.stopPropagation(); Shop.openEditModal(${p.id})"><i class="bi bi-pencil-square"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        },

        openOrderModal(id) {
            const p = products.find(x => x.id === id);
            if(!p) return;
            this.currentOrderProduct = p;
            this.selectedPrices = [];

            document.getElementById('orderProdImg').src = p.img;
            document.getElementById('orderProdName').innerText = p.name;
            document.getElementById('orderProdRef').innerText = "Réf: " + p.uniqueId;
            document.getElementById('orderProdStockBadge').innerHTML = p.stock > 0 ? 
                `<span class="badge bg-success">En Stock (${p.stock})</span>` : 
                `<span class="badge bg-warning text-dark">Sur Commande (Vague ${p.currentWave || 1})</span>`;

            const remaining = this.getRemainingMinQty(p.id);
            const qtyInput = document.getElementById('orderQty');
            const qtyHint = document.getElementById('orderMinQtyHint');
            
            qtyInput.value = 1; 
            qtyInput.min = 1;
            
            if(remaining > 0 && p.minQty > 1) {
                qtyHint.innerText = `Objectif : Encore ${remaining} unités pour lancer le lot (Vague ${p.currentWave || 1}).`;
                qtyHint.style.display = "block";
            } else {
                qtyHint.style.display = "none";
            }

            let priceRows = "";
            if(p.canaux) {
                if(p.canaux.avion?.vente) {
                    const c = p.canaux.avion;
                    const tot = (parseInt(c.vente)||0) + (parseInt(c.transit)||0) + (parseInt(c.douane)||0) + (parseInt(c.liv)||0);
                    priceRows += this.generateOrderRow("Avion", c.vente, c.transit, c.douane, c.liv, tot, "avion");
                }
                if(p.canaux.bateau?.vente) {
                    const c = p.canaux.bateau;
                    const tot = (parseInt(c.vente)||0) + (parseInt(c.transit)||0) + (parseInt(c.douane)||0) + (parseInt(c.liv)||0);
                    priceRows += this.generateOrderRow("Bateau", c.vente, c.transit, c.douane, c.liv, tot, "bateau");
                }
                if(p.canaux.direct?.ttc) {
                    priceRows += `
                    <tr class="order-price-row text-center">
                        <td><small>Magasin</small></td>
                        <td colspan="4" class="text-center"><small>Prix Direct Final</small></td>
                        <td class="fw-bold d-flex align-items-center justify-content-center gap-2">
                            ${p.canaux.direct.ttc.toLocaleString()}
                            <input type="checkbox" id="checkPriceDirect" class="form-check-input" onclick="Shop.togglePriceSelection(${p.canaux.direct.ttc}, this)">
                        </td>
                    </tr>`;
                }
            }
            document.getElementById('orderPriceTable').innerHTML = priceRows || "<tr><td colspan='6' class='text-center'>Aucun tarif défini</td></tr>";
            
            document.getElementById('orderClientName').value = "";
            document.getElementById('orderClientPhone').value = "";
            document.getElementById('orderCustomPrice').value = "";
            document.getElementById('orderPayment').value = "";
            document.getElementById('orderStatusBanner').style.display = "none";
            this.calculateOrder();

            new bootstrap.Modal(document.getElementById('orderModal')).show();
        },

        generateOrderRow(label, v, t, d, l, tot, type) {
            return `
            <tr class="order-price-row text-center" id="row-${type}">
                <td class="fw-bold"><small>${label}</small></td>
                <td><input type="number" value="${v}" readonly> <input type="checkbox" id="checkPrice${type}" class="form-check-input mt-1" onclick="Shop.togglePriceSelection(parseInt(this.previousElementSibling.value), this)"></td>
                <td><input type="number" value="${t}" readonly> <input type="checkbox" id="checkTransit${type}" class="form-check-input mt-1" onclick="Shop.togglePriceSelection(parseInt(this.previousElementSibling.value), this)"></td>
                <td><input type="number" value="${d}" readonly> <input type="checkbox" id="checkDouane${type}" class="form-check-input mt-1" onclick="Shop.togglePriceSelection(parseInt(this.previousElementSibling.value), this)"></td>
                <td><input type="number" value="${l}" readonly> <input type="checkbox" id="checkLivraison${type}" class="form-check-input mt-1" onclick="Shop.togglePriceSelection(parseInt(this.previousElementSibling.value), this)"></td>
                <td class="fw-bold d-flex align-items-center justify-content-center gap-1">
                    <span class="tot-span" style="cursor:pointer;" onclick="Shop.autoSelectRow(this)">${tot}</span>
                </td>
            </tr>`;
        },

        autoSelectRow(spanEl) {
            const row = spanEl.closest('tr');
            const checkboxes = row.querySelectorAll('.form-check-input');
            checkboxes.forEach(cb => {
                if(!cb.checked) {
                    cb.checked = true;
                    let val = 0;
                    if(cb.previousElementSibling) {
                        val = parseInt(cb.previousElementSibling.value || cb.previousElementSibling.innerText) || 0;
                    }
                    if (val > 0) this.selectedPrices.push(val);
                }
            });
            const totalSelected = this.selectedPrices.reduce((sum, val) => sum + val, 0);
            const qty = parseInt(document.getElementById('orderQty').value) || 1;
            document.getElementById('orderCustomPrice').value = totalSelected;
            document.getElementById('orderPayment').value = totalSelected * qty;
            this.calculateOrder();
        },

        togglePriceSelection(price, checkbox) {
            if(checkbox.checked) {
                this.selectedPrices.push(price);
            } else {
                const index = this.selectedPrices.indexOf(price);
                if(index > -1) {
                    this.selectedPrices.splice(index, 1);
                }
            }
            const totalSelected = this.selectedPrices.reduce((sum, val) => sum + val, 0);
            const qty = parseInt(document.getElementById('orderQty').value) || 1;
            document.getElementById('orderCustomPrice').value = totalSelected;
            document.getElementById('orderPayment').value = totalSelected * qty;
            this.calculateOrder();
        },

        calculateOrder() {
            const qty = parseInt(document.getElementById('orderQty').value) || 0;
            const price = parseInt(document.getElementById('orderCustomPrice').value) || 0;
            const payed = parseInt(document.getElementById('orderPayment').value) || 0;
            const total = qty * price;
            document.getElementById('valTotal').innerText = total.toLocaleString() + " F CFA";
            const banner = document.getElementById('orderStatusBanner');
            
            if(qty > 0 && price > 0) {
                banner.style.display = "block";
                const hasStock = (this.currentOrderProduct.stock >= qty);
                const paymentOk = (payed >= total && total > 0);
                
                if(paymentOk) {
                    if(hasStock) {
                        banner.className = "order-status-banner bg-success-subtle text-success border border-success";
                        banner.innerHTML = `<i class="bi bi-check-circle-fill"></i> COMMANDE PRÊTE (STOCK DISPO)`;
                    } else {
                        banner.className = "order-status-banner bg-info-subtle text-primary border border-primary";
                        banner.innerHTML = `<i class="bi bi-clock-history"></i> PROJET ENREGISTRÉ (VAGUE ${this.currentOrderProduct.currentWave || 1})`;
                    }
                } else {
                    banner.className = "order-status-banner bg-danger-subtle text-danger border border-danger";
                    banner.innerHTML = `<i class="bi bi-exclamation-triangle-fill"></i> PAIEMENT INSUFFISANT`;
                }
            } else {
                banner.style.display = "none";
            }
        },

        validateProject() {
            const clientName = document.getElementById('orderClientName').value.trim();
            const clientPhone = document.getElementById('orderClientPhone').value.trim();
            const qty = parseInt(document.getElementById('orderQty').value) || 0;

            if(!clientName || !clientPhone || qty <= 0) {
                alert("Erreur : Veuillez remplir tous les champs obligatoires.");
                return;
            }

            const currentProduct = this.currentOrderProduct;
            const wave = currentProduct.currentWave || 1;
            const now = new Date();
            const dateStr = now.toLocaleDateString('fr-FR');
            const timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

            const newOrder = {
                id: "CMD-" + Date.now(),
                timestamp: Date.now(),
                prodId: currentProduct.id,
                prodName: currentProduct.name,
                wave: wave,
                quantity: qty,
                minOrderRequired: parseInt(currentProduct.minQty) || 1,
                ref: currentProduct.uniqueId,
                client: clientName,
                phone: clientPhone,
                price: parseInt(document.getElementById('orderCustomPrice').value) || 0,
                qty: qty,
                total: (parseInt(document.getElementById('orderCustomPrice').value) || 0) * qty,
                status: (currentProduct.stock >= qty) ? "Validée" : "À Lancer",
                date: `${dateStr} à ${timeStr}`
            };

            orders.push(newOrder);
            localStorage.setItem(ORDERS_KEY, JSON.stringify(orders));

            if(newOrder.status === "Validée") {
                const idx = products.findIndex(x => x.id === currentProduct.id);
                if(idx !== -1) {
                    products[idx].stock -= newOrder.qty;
                    set(ref(db, 'produits/' + products[idx].id), products[idx]);
                }
            }

            this.checkWaveThreshold(currentProduct.id);
            bootstrap.Modal.getInstance(document.getElementById('orderModal')).hide();
            const overlay = document.getElementById('successOverlay');
            overlay.style.display = 'flex';
            setTimeout(() => { window.location.href = "panier.html"; }, 2000);
        },

        checkWaveThreshold(productId) {
            const productIdx = products.findIndex(p => p.id === productId);
            if (productIdx === -1) return;
            const p = products[productIdx];
            const currentWave = p.currentWave || 1;
            const minQty = parseInt(p.minQty) || 1;

            if (minQty > 1) {
                const totalInWave = orders
                    .filter(o => o.prodId === productId && o.wave === currentWave)
                    .reduce((sum, o) => sum + (parseInt(o.qty) || 0), 0);

                if (totalInWave >= minQty) {
                    products[productIdx].currentWave = currentWave + 1;
                    set(ref(db, 'produits/' + productId), products[productIdx]);
                }
            }
        },

        openAddModal() {
            document.getElementById('editProductId').value = "";
            document.getElementById('addProductForm').reset();
            document.getElementById('pImgBase64').value = "";
            document.getElementById('pMinQty').value = 1;
            new bootstrap.Modal(document.getElementById('addModal')).show();
        },

        openEditModal(id) {
            const p = products.find(x => x.id === id);
            if(!p) return;
            document.getElementById('editProductId').value = p.id;
            document.getElementById('pName').value = p.name;
            document.getElementById('pCat').value = p.cat;
            document.getElementById('pQualities').value = p.qualities || "";
            document.getElementById('pStock').value = p.stock || "";
            document.getElementById('pMinQty').value = p.minQty || 1;
            document.getElementById('pPriceBuy').value = p.priceBuy || ""; 
            document.getElementById('pCurrency').value = p.currency || "F CFA";
            document.getElementById('pOrigin').value = p.origin || "";
            document.getElementById('pImgBase64').value = p.img;
            if(p.canaux) {
                document.getElementById('pAvionVente').value = p.canaux.avion?.vente || "";
                document.getElementById('pAvionTransit').value = p.canaux.avion?.transit || "";
                document.getElementById('pAvionDouane').value = p.canaux.avion?.douane || "";
                document.getElementById('pAvionLiv').value = p.canaux.avion?.liv || "";
                document.getElementById('pBateauVente').value = p.canaux.bateau?.vente || "";
                document.getElementById('pBateauTransit').value = p.canaux.bateau?.transit || "";
                document.getElementById('pBateauDouane').value = p.canaux.bateau?.douane || "";
                document.getElementById('pBateauLiv').value = p.canaux.bateau?.liv || "";
                document.getElementById('pDirectTTC').value = p.canaux.direct?.ttc || "";
                document.getElementById('pGrosTTC').value = p.canaux.direct?.grosTTC || "";
                document.getElementById('pGrosQty').value = p.canaux.direct?.grosQty || "";
            }
            new bootstrap.Modal(document.getElementById('addModal')).show();
        },

        saveProduct(e) {
            if(e) { e.preventDefault(); e.stopPropagation(); }
            const btnSave = document.getElementById('btnSaveMain');
            btnSave.disabled = true;
            btnSave.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Traitement...';

            try {
                const editId = document.getElementById('editProductId').value;
                const pOld = editId ? products.find(x => x.id == editId) : null;

                const pData = {
                    id: editId ? parseInt(editId) : Date.now(),
                    uniqueId: editId ? pOld.uniqueId : "BONE-" + Math.random().toString(36).substr(2, 5).toUpperCase(),
                    currentWave: editId ? (pOld.currentWave || 1) : 1,
                    name: document.getElementById('pName').value,
                    priceBuy: parseFloat(document.getElementById('pPriceBuy').value) || 0,
                    cat: document.getElementById('pCat').value,
                    qualities: document.getElementById('pQualities').value,
                    stock: parseInt(document.getElementById('pStock').value) || 0,
                    minQty: parseInt(document.getElementById('pMinQty').value) || 1,
                    currency: document.getElementById('pCurrency').value,
                    origin: document.getElementById('pOrigin').value,
                    img: document.getElementById('pImgBase64').value || "https://via.placeholder.com/150",
                    canaux: {
                        avion: { vente: parseInt(document.getElementById('pAvionVente').value) || 0, transit: parseInt(document.getElementById('pAvionTransit').value) || 0, douane: parseInt(document.getElementById('pAvionDouane').value) || 0, liv: parseInt(document.getElementById('pAvionLiv').value) || 0 },
                        bateau: { vente: parseInt(document.getElementById('pBateauVente').value) || 0, transit: parseInt(document.getElementById('pBateauTransit').value) || 0, douane: parseInt(document.getElementById('pBateauDouane').value) || 0, liv: parseInt(document.getElementById('pBateauLiv').value) || 0 },
                        direct: { ttc: parseInt(document.getElementById('pDirectTTC').value) || 0, grosTTC: parseInt(document.getElementById('pGrosTTC').value) || 0, grosQty: parseInt(document.getElementById('pGrosQty').value) || 0 }
                    }
                };
                
                const prodRef = ref(db, 'produits/' + pData.id);
                set(prodRef, pData).then(() => {
                    sendNotification('Mouvement Produit', `${pData.name} - Enregistré`);
                    bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                });

            } catch (err) {
                alert("Une erreur est survenue lors de l'enregistrement.");
            } finally {
                btnSave.disabled = false;
                btnSave.innerHTML = 'ENREGISTRER';
            }
        },

        showDetails(id) {
            const p = products.find(x => x.id === id);
            if(!p) return;
            const wave = p.currentWave || 1;
            document.getElementById('currentProductId').value = p.id;
            document.getElementById('modalImg').src = p.img;
            document.getElementById('modalTitle').innerText = p.name;
            document.getElementById('modalQualities').innerText = p.qualities || "";
            document.getElementById('modalUniqueIdDisplay').innerText = p.uniqueId;
            document.getElementById('modalOrigin').innerText = "Origine : " + (p.origin || 'N/C');
            
            const waveBadge = document.getElementById('modalWaveNumber');
            if(p.minQty > 1) { waveBadge.innerText = "VAGUE N°" + wave; waveBadge.style.display = "inline-block"; }
            else { waveBadge.style.display = "none"; }

            const totalInWave = orders.filter(o => o.prodId === p.id && o.wave === wave).reduce((sum, o) => sum + (parseInt(o.qty) || 0), 0);
            const minT = parseInt(p.minQty) || 1;

            const stockDiv = document.getElementById('modalStockDisplay');
            if(p.stock && p.stock > 0) { stockDiv.innerHTML = `<span class="stock-badge bg-success text-white">📦 STOCK DISPONIBLE : ${p.stock}</span>`; }
            else { stockDiv.innerHTML = `<span class="stock-badge bg-warning text-dark">⏳ SUR COMMANDE (${totalInWave}/${minT})</span>`; }

            let htmlPrices = "";
            const curr = p.currency || 'F CFA';
            if(p.canaux) {
                const c = p.canaux;
                if(c.avion?.vente) {
                    const tot = (parseInt(c.avion.vente)||0) + (parseInt(c.avion.transit)||0) + (parseInt(c.avion.douane)||0) + (parseInt(c.avion.liv)||0);
                    htmlPrices += `<div class="mb-2 p-2 border rounded"><div class="d-flex justify-content-between fw-bold text-primary"><span>✈️ AVION</span><span>${tot.toLocaleString()} ${curr}</span></div><div class="price-detail-box">Base: ${c.avion.vente} | Transit: ${c.avion.transit} | Douane: ${c.avion.douane} | Liv: ${c.avion.liv}</div></div>`;
                }
                if(c.bateau?.vente) {
                    const tot = (parseInt(c.bateau.vente)||0) + (parseInt(c.bateau.transit)||0) + (parseInt(c.bateau.douane)||0) + (parseInt(c.bateau.liv)||0);
                    htmlPrices += `<div class="mb-2 p-2 border rounded"><div class="d-flex justify-content-between fw-bold text-info"><span>🚢 BATEAU</span><span>${tot.toLocaleString()} ${curr}</span></div><div class="price-detail-box">Base: ${c.bateau.vente} | Transit: ${c.bateau.transit} | Douane: ${c.bateau.douane} | Liv: ${c.bateau.liv}</div></div>`;
                }
                if(c.direct?.ttc) { htmlPrices += `<div class="mb-2 p-2 border rounded bg-light"><div class="d-flex justify-content-between fw-bold text-success"><span>🏠 AU MAGASIN (Direct)</span><span>${c.direct.ttc.toLocaleString()} ${curr}</span></div></div>`; }
            }
            document.getElementById('modalPriceList').innerHTML = htmlPrices || "<p class='text-muted'>Aucun prix configuré</p>";
            this.loadBrandConfig();
            new bootstrap.Modal(document.getElementById('productModal')).show();
        },

        getPublishText() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            const p = products.find(x => x.id == document.getElementById('currentProductId').value);
            const wave = p.currentWave || 1;
            const totalInWave = orders.filter(o => o.prodId === p.id && o.wave === wave).reduce((sum, o) => sum + (parseInt(o.qty) || 0), 0);
            const minT = parseInt(p.minQty) || 1;
            
            // Correction progression commandes
            const progressionStr = minT > 1 ? `(${totalInWave}/${minT} - V${wave})` : "";
            const stockTxt = (p && p.stock > 0) ? `✅ Stock : ${p.stock}` : `⏳ Sur commande ${progressionStr}`;
            
            const phoneForLink = (config.ceoWhatsapp || "").replace(/\s+/g, '').replace('+', '');
            const curr = p.currency || 'F CFA';
            let priceTxt = "";
            if(p.canaux) {
                if(p.canaux.avion?.vente) { const c = p.canaux.avion; const tot = (parseInt(c.vente)||0) + (parseInt(c.transit)||0) + (parseInt(c.douane)||0) + (parseInt(c.liv)||0); priceTxt += `✈️ *AVION :* ${tot.toLocaleString()} ${curr}\n`; }
                if(p.canaux.bateau?.vente) { const c = p.canaux.bateau; const tot = (parseInt(c.vente)||0) + (parseInt(c.transit)||0) + (parseInt(c.douane)||0) + (parseInt(c.liv)||0); priceTxt += `🚢 *BATEAU :* ${tot.toLocaleString()} ${curr}\n`; }
                if(p.canaux.direct?.ttc) { priceTxt += `🏠 *MAGASIN :* ${p.canaux.direct.ttc.toLocaleString()} ${curr}\n`; }
            }
            return `🌟 *DISPONIBILITÉ : ${config.companyName || "MT & B-One"}*\n━━━━━━━━━━━━━━━━━━\n\n📦 *Produit :* ${p.name}\n🔍 *Réf :* ${p.uniqueId}\n📊 *État :* ${stockTxt}\n✨ *Qualités :* ${p.qualities || 'Qualité Premium'}\n\n💰 *TARIFS :*\n${priceTxt}\n📲 *Contact PDG :* https://wa.me/${phoneForLink}\n✍️ _Signé : ${config.ceoName || "L'Administrateur"}_`;
        },

        publishToStatus() { window.open(`https://wa.me/?text=${encodeURIComponent(this.getPublishText())}`, '_blank'); },

        shareProductImg() {
            const area = document.getElementById('captureArea');
            html2canvas(area, { useCORS: true, scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Fiche_Produit.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        },

        shareProductLink() {
            const config = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            const phoneForLink = (config.ceoWhatsapp || "").replace(/\s+/g, '').replace('+', '');
            const msg = `*DEMANDE DE COMMANDE*\nJe souhaite commander : ${document.getElementById('modalTitle').innerText} (Ref: ${document.getElementById('modalUniqueIdDisplay').innerText})`;
            window.open(`https://wa.me/${phoneForLink}?text=${encodeURIComponent(msg)}`, '_blank');
        },

        deleteCurrentProduct() {
            if(confirm("Supprimer ?")) {
                const id = document.getElementById('currentProductId').value;
                remove(ref(db, 'produits/' + id)).then(() => {
                    bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
                });
            }
        },

        renderAdminTable() {
            const tbody = document.getElementById('adminProductTable');
            if(!tbody) return;
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><code class="small">${p.uniqueId}</code></td>
                    <td><b>${p.name}</b> <small class="text-muted">(V${p.currentWave || 1})</small></td>
                    <td><span class="badge ${p.stock > 0 ? 'bg-success' : 'bg-secondary'}">${p.stock || 0}</span></td>
                    <td>${p.canaux?.avion?.vente ? '✈️' : ''} ${p.canaux?.bateau?.vente ? '🚢' : ''} ${p.canaux?.direct?.ttc ? '🏠' : ''}</td>
                    <td class="text-end">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="Shop.duplicateProduct(${p.id})"><i class="bi bi-copy"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="Shop.deleteProduct(${p.id})"><i class="bi bi-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        },

        renderOrdersTable() {
            const tbody = document.getElementById('adminOrdersTable');
            if(!tbody) return;
            tbody.innerHTML = orders.map(o => `
                <tr>
                    <td><small>${o.date}</small></td>
                    <td><b>${o.client}</b></td>
                    <td>${o.prodName} (x${o.qty}) <small class="text-muted">V${o.wave}</small></td>
                    <td class="fw-bold">${o.total.toLocaleString()}</td>
                    <td><span class="badge ${o.status === 'Validée' ? 'bg-success' : 'bg-info'}">${o.status}</span></td>
                    <td class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="Shop.deleteOrder(${o.id})"><i class="bi bi-trash-fill"></i></button>
                    </td>
                </tr>
            `).reverse().join('');
        },

        deleteOrder(id) {
            if(confirm("Supprimer ?")) { orders = orders.filter(o => o.id != id); localStorage.setItem(ORDERS_KEY, JSON.stringify(orders)); this.renderOrdersTable(); }
        },

        duplicateProduct(id) {
            const p = products.find(x => x.id === id);
            const clone = JSON.parse(JSON.stringify(p));
            clone.id = Date.now();
            clone.uniqueId = "BONE-" + Math.random().toString(36).substr(2, 5).toUpperCase();
            clone.name += " (Copie)"; clone.currentWave = 1;
            set(ref(db, 'produits/' + clone.id), clone);
        },

        deleteProduct(id) {
            if(confirm("Supprimer ?")) {
                remove(ref(db, 'produits/' + id));
            }
        },

        search() { const q = document.getElementById('searchInput').value.toLowerCase(); this.render(products.filter(p => p.name.toLowerCase().includes(q))); },

        filter(cat, el) {
            document.querySelectorAll('.cat-badge').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            this.render(cat === 'Tous' ? products : products.filter(p => p.cat === cat));
        }
    };

    window.Shop = Shop;

    const imgInput = document.getElementById('pImgFile');
    if(imgInput) {
        imgInput.onchange = function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(event) { document.getElementById('pImgBase64').value = event.target.result; };
            reader.readAsDataURL(file);
        };
    }

    const addForm = document.getElementById('addProductForm');
    if(addForm) {
        addForm.onsubmit = function(e) {
            Shop.saveProduct(e);
        };
    }

    window.onload = () => { Shop.init(); };

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<button onclick="logout()" class="btn btn-danger position-fixed bottom-0 end-0 m-3 rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 55px; height: 55px; z-index: 2000; border: 2px solid white;">
    <i class="bi bi-power fs-4"></i>
</button>

<script>
    function logout() {
        if (confirm("Atizoun, voulez-vous vraiment vous déconnecter de B-one ?")) {
            localStorage.removeItem('BONE_USER_SESSION');
            window.location.href = 'login.html';
        }
    }
</script>

</body>
</html>
